
<!DOCTYPE html>
<!-- saved from url=(0039)https://pn2beprix.github.io/smac-carto/ -->
<html lang="fr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <title>Cartographie SMAC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link href="./Cartographie SMAC mdp_files/css2" rel="stylesheet">
  <style>
    :root {
      --red: #e10600;
      --red-dark: #c70500;
      --red-light: #fff5f5;
      --dark: #1a1a1a;
      --gray-50: #fafafa;
      --gray-100: #f5f5f5;
      --gray-200: #e5e5e5;
      --gray-300: #d4d4d4;
      --gray-500: #737373;
      --gray-700: #404040;
      --gray-800: #262626;
      --gray-900: #171717;
      --green: #22c55e;
      --green-light: #dcfce7;
      --orange: #f59e0b;
      --orange-light: #fef3c7;
      --blue: #3b82f6;
      --blue-light: #dbeafe;
      --rose: #f43f5e;
      --rose-light: #ffe4e6;
      --purple: #8b5cf6;
      --purple-light: #ede9fe;
      --cyan: #06b6d4;
      --cyan-light: #cffafe;
      --radius: 8px;
      --radius-sm: 6px;
      --shadow: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 2px 4px rgba(0,0,0,0.06);
      --shadow-lg: 0 4px 8px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { 
      height: 100%; 
      height: -webkit-fill-available;
      overflow: hidden;
    }
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #e5e5e5;
      color: var(--dark);
      line-height: 1.5;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow: hidden;
    }

    /* === HEADER === */
    header {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--red);
      letter-spacing: -0.3px;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }

    .logo-subtitle {
      font-size: 12px;
      color: var(--gray-700);
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* === TABS with Drag & Drop === */
    .tabs-container {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(25px) saturate(180%);
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding: 0 24px;
      display: flex;
      gap: 0;
      align-items: center;
      overflow-x: auto;
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      z-index: 999;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      height: 56px;
    }

    @media (max-width: 1024px) {
      .tabs-container {
        right: 0;
      }
    }

    .tabs-wrapper {
      display: flex;
      gap: 4px;
      flex: 1;
      padding: 8px 0;
    }

    .tab-btn {
      padding: 10px 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      cursor: grab;
      position: relative;
      transition: all 0.2s ease;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }

    .tab-btn:hover {
      color: var(--dark);
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }

    .tab-btn.active {
      color: var(--red);
      background: rgba(255, 245, 245, 0.5);
      border-color: rgba(225, 6, 0, 0.3);
      box-shadow: 0 2px 10px rgba(225, 6, 0, 0.15);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 2px;
      background: var(--red);
      border-radius: 3px 3px 0 0;
    }

    /* Drag states */
    .tab-btn.dragging {
      opacity: 0.5;
      cursor: grabbing;
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
      z-index: 100;
    }

    .tab-btn.drag-over {
      background: var(--blue-light);
      transform: translateX(4px);
    }

    .tab-btn.drag-over-left {
      transform: translateX(-4px);
    }

    .drop-indicator {
      position: absolute;
      width: 3px;
      height: 32px;
      background: var(--red);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 50;
    }

    .drop-indicator.visible {
      opacity: 1;
      animation: pulse 0.5s ease infinite alternate;
    }

    @keyframes pulse {
      from { transform: scaleY(0.9); }
      to { transform: scaleY(1.1); }
    }

    .tab-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      transition: transform 0.3s;
    }

    .tab-btn:hover .tab-dot {
      transform: scale(1.3);
    }

    .tab-btn .tab-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      padding: 0 6px;
      border-radius: 11px;
      font-size: 11px;
      font-weight: 600;
      background: var(--gray-100);
      color: var(--gray-500);
      transition: all 0.3s;
    }

    .tab-btn.active .tab-count {
      background: var(--red);
      color: white;
      transform: scale(1.1);
    }

    .tab-actions {
      display: flex;
      gap: 2px;
      opacity: 0;
      transform: translateX(-4px);
      transition: all 0.2s;
    }
    .tab-btn:hover .tab-actions { 
      opacity: 1; 
      transform: translateX(0);
    }

    .tab-action-btn {
      width: 22px;
      height: 22px;
      border: none;
      background: transparent;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.2s;
    }
    .tab-action-btn:hover { 
      background: var(--gray-200); 
      color: var(--dark); 
      transform: scale(1.1);
    }
    .tab-action-btn.delete:hover { 
      background: var(--rose-light); 
      color: var(--rose); 
    }

    .drag-handle {
      cursor: grab;
      opacity: 0;
      transition: opacity 0.2s;
      color: var(--gray-400);
    }

    .tab-btn:hover .drag-handle {
      opacity: 1;
    }

    .add-tab-btn {
      padding: 8px 16px;
      border: 2px dashed var(--gray-300);
      background: transparent;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-500);
      cursor: pointer;
      margin-left: auto;
      white-space: nowrap;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .add-tab-btn:hover { 
      border-color: var(--red); 
      color: var(--red); 
      background: var(--red-light);
      transform: scale(1.02);
    }

    .add-tab-btn svg {
      transition: transform 0.3s;
    }

    .add-tab-btn:hover svg {
      transform: rotate(90deg);
    }

    /* === BUTTONS === */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary { 
      background: var(--red); 
      color: white; 
    }
    .btn-primary:hover { 
      background: var(--red-dark);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.6);
      color: var(--dark);
      border: 1px solid rgba(229, 229, 229, 0.8);
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }
    .btn-secondary:hover { 
      background: rgba(255, 255, 255, 0.8);
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-700);
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }
    .btn-ghost:hover { 
      background: rgba(245, 245, 245, 0.4); 
      color: var(--dark); 
    }

    .btn-sm { padding: 6px 10px; font-size: 12px; }

    /* Refresh button animation */
    .btn-ghost.refreshing svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* === MAIN LAYOUT === */
    main {
      display: grid;
      grid-template-columns: 1fr 420px;
      height: 100vh;
      height: 100dvh;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }

    @media (max-width: 1024px) {
      main { 
        grid-template-columns: 1fr; 
        height: 100vh;
        height: 100dvh;
      }
      .sidebar { display: none; }
    }

    /* === MAP === */
    #map {
      width: 100%;
      height: 100%;
      min-height: 300px;
      background: #e5e5e5;
      position: relative;
      z-index: 0;
      overflow: hidden;
    }

    /* === SIDEBAR === */
    .sidebar {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-left: 1px solid rgba(229, 229, 229, 0.6);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 10;
      position: relative;
      padding-top: 112px;
    }

    /* === TAB CONTENT ANIMATION === */
    .tab-content {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.4s ease forwards;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* === SEARCH & FILTERS === */
    .search-section {
      padding: 16px;
      border-bottom: 1px solid rgba(229, 229, 229, 0.6);
    }

    .search-box {
      display: flex;
      gap: 8px;
    }

    .search-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid rgba(229, 229, 229, 0.8);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 14px;
      background: rgba(250, 250, 250, 0.5);
      transition: all 0.2s;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--red);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 3px rgba(225, 6, 0, 0.1);
    }

    /* Sort Select */
    .sort-select {
      padding: 8px 10px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 12px;
      background: white;
      cursor: pointer;
      min-width: 130px;
      transition: all 0.2s;
    }
    .sort-select:focus { 
      outline: none; 
      border-color: var(--red); 
    }

    /* Description style */
    .list-item-description {
      font-size: 11px;
      color: var(--blue);
      font-style: italic;
      margin-top: 4px;
      padding: 3px 8px;
      background: var(--blue-light);
      border-radius: 4px;
      display: inline-block;
    }

    /* Tags */
    .list-item-tags { 
      display: flex; 
      gap: 4px; 
      flex-wrap: wrap; 
      margin-top: 4px; 
    }
    .tag {
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 9px;
      font-weight: 600;
      background: var(--purple-light);
      color: var(--purple);
    }

    /* Responsable badge */
    .responsable-badge {
      font-size: 10px;
      color: var(--cyan);
    }

    /* Tags input */
    .tags-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 6px 8px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      background: var(--gray-50);
      min-height: 36px;
      align-items: center;
      transition: all 0.2s;
    }
    .tags-input-container:focus-within {
      border-color: var(--red);
      background: white;
    }
    .tags-input-container .tag { 
      cursor: pointer; 
      transition: all 0.2s;
    }
    .tags-input-container .tag:hover { 
      opacity: 0.7;
      transform: scale(0.95);
    }
    .tags-input {
      border: none;
      outline: none;
      background: transparent;
      font-family: inherit;
      font-size: 12px;
      flex: 1;
      min-width: 60px;
      color: var(--dark);
    }

    /* Geocode button */
    .geocode-btn {
      padding: 8px 10px;
      background: var(--blue);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 11px;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .geocode-btn:hover { 
      background: #2563eb;
      transform: translateY(-1px);
    }

    /* Kbd */
    .kbd {
      display: inline-block;
      padding: 2px 6px;
      font-size: 11px;
      font-family: monospace;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 4px;
      color: var(--gray-500);
    }

    /* Filter Pills */
    .filter-pills {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid transparent;
      background: var(--gray-100);
      color: var(--gray-500);
    }
    .pill:hover { 
      background: var(--gray-200);
      transform: translateY(-1px);
    }
    .pill.active { 
      background: var(--dark); 
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .pill.gagne { background: var(--green-light); color: #166534; border-color: #bbf7d0; }
    .pill.gagne.active { background: var(--green); color: white; }

    .pill.perdu { background: var(--rose-light); color: #9f1239; border-color: #fecdd3; }
    .pill.perdu.active { background: var(--rose); color: white; }

    .pill.encours { background: var(--orange-light); color: #92400e; border-color: #fde68a; }
    .pill.encours.active { background: var(--orange); color: white; }

    .pill.faste { background: var(--blue-light); color: #1d4ed8; border-color: #bfdbfe; }
    .pill.faste.active { background: var(--blue); color: white; }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      font-size: 12px;
      color: var(--gray-500);
    }

    .stats-bar strong { color: var(--dark); }

    /* === LIST === */
    .list-container {
      flex: 1;
      overflow-y: auto;
    }

    .list-item {
      padding: 14px 16px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
      transition: all 0.2s;
      animation: listItemIn 0.3s ease backwards;
    }

    .list-item:nth-child(1) { animation-delay: 0.02s; }
    .list-item:nth-child(2) { animation-delay: 0.04s; }
    .list-item:nth-child(3) { animation-delay: 0.06s; }
    .list-item:nth-child(4) { animation-delay: 0.08s; }
    .list-item:nth-child(5) { animation-delay: 0.1s; }
    .list-item:nth-child(6) { animation-delay: 0.12s; }
    .list-item:nth-child(7) { animation-delay: 0.14s; }
    .list-item:nth-child(8) { animation-delay: 0.16s; }
    .list-item:nth-child(9) { animation-delay: 0.18s; }
    .list-item:nth-child(10) { animation-delay: 0.2s; }

    @keyframes listItemIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .list-item:hover { 
      background: rgba(250, 250, 250, 0.6);
      transform: translateX(4px);
    }

    .list-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 6px;
    }

    .list-item-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--dark);
    }

    .list-item-meta {
      font-size: 12px;
      color: var(--gray-500);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .list-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }

    .list-item-amount {
      font-weight: 600;
      font-size: 13px;
      color: var(--dark);
    }

    .list-item-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transform: translateX(10px);
      transition: all 0.2s;
    }
    .list-item:hover .list-item-actions { 
      opacity: 1;
      transform: translateX(0);
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--gray-500);
      transition: all 0.2s;
    }
    .btn-icon:hover { 
      background: var(--gray-200); 
      color: var(--dark);
      transform: scale(1.1);
    }
    .btn-icon.delete:hover { 
      background: var(--rose-light); 
      color: var(--rose); 
    }

    /* Status Badge */
    .status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .list-item:hover .status {
      transform: scale(1.05);
    }

    .status.gagne { background: var(--green-light); color: #166534; }
    .status.perdu { background: var(--rose-light); color: #9f1239; }
    .status.encours { background: var(--orange-light); color: #92400e; }
    .status.faste { background: var(--blue-light); color: #1d4ed8; }

    /* Total Bar */
    .total-bar {
      padding: 14px 16px;
      background: linear-gradient(135deg, var(--red-light) 0%, white 100%);
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .total-bar span { font-size: 13px; color: var(--gray-500); }
    .total-bar strong { 
      font-size: 18px; 
      color: var(--dark);
      font-weight: 700;
    }

    /* === MODAL === */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .modal-overlay.open { 
      display: flex;
      opacity: 1;
    }

    .modal {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(229, 229, 229, 0.8);
      border-radius: var(--radius);
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      animation: modalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes modalIn {
      from { 
        opacity: 0; 
        transform: scale(0.9) translateY(20px); 
      }
      to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
      }
    }

    .modal-header {
      padding: 18px 20px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 17px;
      font-weight: 600;
    }

    .modal-body { 
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group.full { grid-column: span 2; }

    .form-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--gray-500);
    }

    .form-input, .form-select, .form-textarea {
      padding: 10px 12px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--red);
      box-shadow: 0 0 0 3px rgba(225, 6, 0, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Chips Select */
    .chips-select {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chips-select .chip {
      padding: 6px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      background: white;
      transition: all 0.2s;
    }
    .chips-select .chip:hover { 
      border-color: var(--red);
      transform: translateY(-1px);
    }
    .chips-select .chip.active { 
      background: var(--red-light); 
      border-color: var(--red); 
      color: var(--red);
    }

    /* Advanced Filters */
    .advanced-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--gray-500);
      cursor: pointer;
      background: transparent;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      margin-top: 12px;
      transition: all 0.2s;
    }
    .advanced-toggle:hover { 
      background: var(--gray-100);
    }
    .advanced-toggle .arrow { 
      transition: transform 0.3s; 
    }
    .advanced-toggle.open .arrow { 
      transform: rotate(180deg); 
    }

    .advanced-panel {
      display: none;
      padding: 12px 0;
      gap: 8px;
      flex-direction: column;
      animation: slideDown 0.3s ease;
    }
    .advanced-panel.open { display: flex; }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .advanced-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .filter-group { display: flex; flex-direction: column; gap: 2px; }
    .filter-group label { font-size: 10px; color: var(--gray-500); }
    .filter-group input {
      padding: 6px 8px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 12px;
    }

    .advanced-actions {
      display: flex;
      gap: 6px;
    }
    .advanced-actions button {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
    }

    /* Leaflet custom */
    .leaflet-marker-icon {
      transition: transform 0.2s;
    }
    .leaflet-marker-icon:hover {
      transform: scale(1.1);
    }

    /* Leaflet custom */
    .leaflet-container {
      background: #e5e5e5;
    }
    
    .leaflet-marker-icon {
      transition: transform 0.2s;
    }
    .leaflet-marker-icon:hover {
      transform: scale(1.1);
    }

    .legend {
      background: white;
      padding: 10px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
    }
    .legend-title { font-weight: 600; font-size: 12px; margin-bottom: 6px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; margin: 4px 0; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* Map Popup */
    .leaflet-popup-content-wrapper {
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
    }
    .popup-content { font-family: 'DM Sans', sans-serif; }
    .popup-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .popup-client { font-size: 12px; color: var(--gray-500); }
    .popup-amount { font-weight: 600; color: var(--red); margin-top: 4px; }

    /* Mobile */
    .mobile-menu-btn {
      display: none;
      padding: 8px;
      border: none;
      background: var(--gray-100);
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    @media (max-width: 1024px) {
      .mobile-menu-btn { display: flex; }
    }

    .mobile-sidebar {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 200;
    }
    .mobile-sidebar.open { display: block; }

    .mobile-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(2px);
    }

    .mobile-sidebar-content {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 100%;
      max-width: 400px;
      background: white;
      display: flex;
      flex-direction: column;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .mobile-header {
      padding: 16px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Tab indicator colors */
    .tab-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .tab-indicator.dc { background: var(--blue); }
    .tab-indicator.proj { background: var(--purple); }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: var(--dark);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 13px;
      box-shadow: var(--shadow-lg);
      animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes toastOut {
      to {
        opacity: 0;
        transform: translateY(-10px) scale(0.9);
      }
    }

    .toast.success { background: var(--green); }
    .toast.error { background: var(--rose); }

    /* Duplicate Tab List */
    .duplicate-tab-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .duplicate-tab-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 14px;
      text-align: left;
    }

    .duplicate-tab-option:hover {
      border-color: var(--red);
      background: var(--red-light);
      transform: translateX(4px);
    }

    .duplicate-tab-option.current {
      border-style: dashed;
      opacity: 0.7;
    }

    .duplicate-tab-option.current:hover {
      border-color: var(--gray-400);
      background: var(--gray-100);
    }

    .duplicate-tab-option .tab-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .duplicate-tab-option .tab-info {
      flex: 1;
    }

    .duplicate-tab-option .tab-name {
      font-weight: 600;
      color: var(--dark);
    }

    .duplicate-tab-option .tab-count {
      font-size: 12px;
      color: var(--gray-500);
    }

    .duplicate-tab-option .current-badge {
      font-size: 10px;
      padding: 2px 8px;
      background: var(--gray-200);
      border-radius: 10px;
      color: var(--gray-500);
    }

    /* Protected Tab Styles */
    .tab-btn .lock-icon {
      font-size: 12px;
      margin-left: 4px;
      animation: lockPulse 2s ease infinite;
    }

    @keyframes lockPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .tab-btn.locked {
      opacity: 0.7;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(0,0,0,0.03) 10px,
        rgba(0,0,0,0.03) 20px
      );
    }

    .tab-btn.locked .tab-name {
      font-style: italic;
    }

    .tab-btn.locked:hover {
      opacity: 0.85;
    }

    .tab-btn.protected {
      border: 2px solid var(--orange);
      background: var(--orange-light);
    }

    .tab-btn.protected.active {
      border-color: var(--red);
    }

    .tab-action-btn.lock {
      font-size: 12px;
    }

    .tab-action-btn.lock.has-password {
      color: var(--orange);
      background: var(--orange-light);
    }

    /* Password Modal */
    .password-input-container {
      position: relative;
    }

    .password-input-container input {
      width: 100%;
      padding-right: 40px;
    }

    .password-toggle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.6;
    }

    .password-toggle:hover {
      opacity: 1;
    }

    .password-strength {
      height: 4px;
      border-radius: 2px;
      margin-top: 8px;
      background: var(--gray-200);
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      border-radius: 2px;
      transition: all 0.3s;
    }

    .password-strength-bar.weak { width: 33%; background: var(--rose); }
    .password-strength-bar.medium { width: 66%; background: var(--orange); }
    .password-strength-bar.strong { width: 100%; background: var(--green); }

    .unlock-hint {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
  </style>
<link rel="stylesheet" href="./Cartographie SMAC mdp_files/leaflet.css"><link rel="stylesheet" href="./Cartographie SMAC mdp_files/MarkerCluster.css"><link rel="stylesheet" href="./Cartographie SMAC mdp_files/MarkerCluster.Default.css"></head>
<body>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- HEADER -->
  <header>
    <div class="logo">
      <div>
        <div class="logo-text">SMAC</div>
        <div class="logo-subtitle">Cartographie des affaires</div>
      </div>
    </div>
    <div class="header-actions">
      <span id="syncStatus" style="font-size: 12px; margin-right: 8px; color: #71717a;">‚òÅÔ∏è En ligne</span>
      <button class="btn btn-ghost btn-sm" id="refreshBtn" title="Actualiser (R)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
      </button>
      <button class="btn btn-secondary" id="exportExcel" title="Export Excel (E)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
        Excel
      </button>
      <button class="btn btn-secondary" id="exportPdf" title="Export PDF (P)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
        PDF
      </button>
      <button class="btn btn-primary" id="addBtn" title="Nouvelle affaire (N)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Ajouter
      </button>
      <button class="btn btn-ghost btn-sm" id="shareBtn" title="Partager">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
      </button>
      <button class="btn btn-ghost btn-sm" id="helpBtn" title="Aide (?)">‚ùì</button>
      <button class="btn btn-ghost btn-sm mobile-menu-btn" id="mobileMenuBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </button>
    </div>
  </header>

  <!-- TABS with Drag & Drop -->
  <div class="tabs-container">
    <div class="tabs-wrapper" id="tabsWrapper"><button class="tab-btn active  " data-tab="datacenter" data-index="0" draggable="true">
          <span class="drag-handle">‚ãÆ‚ãÆ</span>
          <span class="tab-dot" style="background:#3b82f6"></span>
          <span class="tab-name">Data-Centers</span>
          
          <span class="tab-count">19</span>
          <span class="tab-actions">
            <button class="tab-action-btn lock " title="Prot√©ger">üîí</button>
            <button class="tab-action-btn rename" title="Renommer">‚úèÔ∏è</button>
            <button class="tab-action-btn delete" title="Supprimer">‚úï</button>
          </span>
        </button><button class="tab-btn  locked protected" data-tab="projets" data-index="1" draggable="true">
          <span class="drag-handle">‚ãÆ‚ãÆ</span>
          <span class="tab-dot" style="background:#8b5cf6"></span>
          <span class="tab-name">Projets Chiffr√©s 2026</span>
          <span class="lock-icon">üîí</span>
          <span class="tab-count">1</span>
          <span class="tab-actions">
            <button class="tab-action-btn lock has-password" title="Retirer la protection">üîì</button>
            <button class="tab-action-btn rename" title="Renommer">‚úèÔ∏è</button>
            <button class="tab-action-btn delete" title="Supprimer">‚úï</button>
          </span>
        </button></div>
    <div class="drop-indicator" id="dropIndicator"></div>
    <button class="add-tab-btn" id="addTabBtn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      Onglet
    </button>
  </div>

  <!-- MAIN -->
  <main>
    <div id="map"></div>
    <div class="sidebar">
      <div class="search-section">
        <div class="search-box">
          <input type="text" class="search-input" id="searchInput" placeholder="Rechercher une affaire...">
          <select class="sort-select" id="sortSelect">
            <option value="name">Tri: Nom A-Z</option>
            <option value="name-desc">Tri: Nom Z-A</option>
            <option value="amount-desc">Tri: Montant ‚Üì</option>
            <option value="amount-asc">Tri: Montant ‚Üë</option>
            <option value="date">Tri: Date</option>
          </select>
        </div>
        <div class="filter-pills">
          <span class="pill active" data-filter="Tous">Tous</span>
          <span class="pill gagne" data-filter="Gagn√©">‚úì Gagn√©</span>
          <span class="pill perdu" data-filter="Perdu">‚úï Perdu</span>
          <span class="pill encours" data-filter="En cours">‚ó∑ En cours</span>
          <span class="pill faste" data-filter="Faste">‚ö° Faste</span>
        </div>
        <button class="advanced-toggle" id="advancedToggle">
          <span class="arrow">‚ñº</span> Filtres avanc√©s
        </button>
        <div class="advanced-panel" id="advancedPanel">
          <div class="advanced-grid">
            <div class="filter-group">
              <label>MOA</label>
              <input type="text" id="fClient" placeholder="Ex: EQUINIX">
            </div>
            <div class="filter-group">
              <label>EG</label>
              <input type="text" id="fEG" placeholder="Ex: BY">
            </div>
            <div class="filter-group">
              <label>MOE</label>
              <input type="text" id="fArchitect" placeholder="Ex: RBA">
            </div>
            <div class="filter-group">
              <label>Adresse</label>
              <input type="text" id="fAdresse" placeholder="Ex: Paris">
            </div>
            <div class="filter-group">
              <label>Montant min</label>
              <input type="text" id="minMontant" placeholder="Ex: 100000">
            </div>
            <div class="filter-group">
              <label>Montant max</label>
              <input type="text" id="maxMontant" placeholder="Ex: 5000000">
            </div>
          </div>
          <div class="advanced-actions">
            <button id="applyAdvanced" style="background: var(--red); color: white;">Appliquer</button>
            <button id="resetAdvanced" style="background: var(--gray-200);">R√©initialiser</button>
            <button id="resetData" style="background: var(--rose-light); color: var(--rose);">‚ö†Ô∏è Reset donn√©es</button>
          </div>
        </div>
      </div>
      <div class="stats-bar">
        <span><strong id="countDisplay">19</strong> affaires affich√©es</span>
        <span id="statusStats">
        <span style="color:#22c55e">‚úì6</span>
        <span style="color:#f43f5e;margin-left:6px">‚úï2</span>
        <span style="color:#f59e0b;margin-left:6px">‚ó∑10</span>
        <span style="color:#3b82f6;margin-left:6px">‚ö°1</span>
      </span>
      </div>
      <div class="list-container" id="listContainer">
          <div class="list-item" data-id="dc_1767782424344_b4dmpu" data-idx="0">
            <div class="list-item-header">
              <span class="list-item-title">1&amp;2 - PAR2</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>COLT ¬∑ BY</span>
              <span>Villebon-sur-Yvette</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">5‚ÄØ000‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767783496738_gxdjiy" data-idx="1">
            <div class="list-item-header">
              <span class="list-item-title">Data center PAR 15 Dugny</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>Digital ¬∑ BY</span>
              <span>1 Avenue du 2√®me DB</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">1‚ÄØ762‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767783665882_h3x2aj" data-idx="2">
            <div class="list-item-header">
              <span class="list-item-title">DATA CENTER VSG Bardage</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>GOODMAN ¬∑ Mercury</span>
              <span>34 Rue Louis Armand, Villeneuve-Saint-Georges, 94190, France</span>
              <span class="responsable-badge">üë§ Maxime</span>
            </div>
            <div class="list-item-description">Bardage</div>
            
            <div class="list-item-footer">
              <span class="list-item-amount">11‚ÄØ685‚ÄØ363&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767783749178_075yoa" data-idx="3">
            <div class="list-item-header">
              <span class="list-item-title">DATA CENTER VSG Etancheit√©</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>GOODMAN ¬∑ Mercury</span>
              <span>34 Rue Louis Armand, Villeneuve-Saint-Georges, 94190, France</span>
              <span class="responsable-badge">üë§ Maxime</span>
            </div>
            <div class="list-item-description">Etanch√©it√©</div>
            
            <div class="list-item-footer">
              <span class="list-item-amount">7‚ÄØ573‚ÄØ840&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767969607910_t33kfl" data-idx="4">
            <div class="list-item-header">
              <span class="list-item-title">DATA HILLS 3</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>HILLS ¬∑ Vinci</span>
              <span>Aulnay-sous-Bois</span>
              <span class="responsable-badge">üë§ Richad</span>
            </div>
            <div class="list-item-description">Fa√ßade/Couverture</div>
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ250‚ÄØ786&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_2vsynb" data-idx="5">
            <div class="list-item-header">
              <span class="list-item-title">DATA VELIZY</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>Nation Data Center ¬∑ BY</span>
              <span>V√©lizy-Villacoublay</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ275‚ÄØ398&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_1ddfqs" data-idx="6">
            <div class="list-item-header">
              <span class="list-item-title">Global Switch - Est</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>GLOBAL SWITCH ¬∑ BY</span>
              <span>Clichy</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">410‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_lmizhn" data-idx="7">
            <div class="list-item-header">
              <span class="list-item-title">Interxion PAR 10 &amp; 11</span>
              <span class="status perdu">‚úï Perdu</span>
            </div>
            <div class="list-item-meta">
              <span>INTERXION ¬∑ BY</span>
              <span>La Courneuve</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">-</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_p25gp8" data-idx="8">
            <div class="list-item-header">
              <span class="list-item-title">Interxion PAR7</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>INTERXION ¬∑ BY</span>
              <span>La Courneuve</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">1‚ÄØ500‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_zuksre" data-idx="9">
            <div class="list-item-header">
              <span class="list-item-title">PA10</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>EQUINIX ¬∑ BY</span>
              <span>Saint-Denis</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">14‚ÄØ541&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_bluynv" data-idx="10">
            <div class="list-item-header">
              <span class="list-item-title">PA14</span>
              <span class="status perdu">‚úï Perdu</span>
            </div>
            <div class="list-item-meta">
              <span>EQUINIX ¬∑ BY</span>
              <span>Aubervilliers</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ945‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_9glssy" data-idx="11">
            <div class="list-item-header">
              <span class="list-item-title">PA15</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>EQUINIX ¬∑ BY</span>
              <span>Meudon</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">7‚ÄØ079‚ÄØ169&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_km8rig" data-idx="12">
            <div class="list-item-header">
              <span class="list-item-title">PAR01</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>GOODMAN ¬∑ BY</span>
              <span>Tremblay-en-France</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ511‚ÄØ133&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_lg29xn" data-idx="13">
            <div class="list-item-header">
              <span class="list-item-title">PAR03</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>MICROSOFT ¬∑ BY</span>
              <span>V√©lizy-Villacoublay</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">913‚ÄØ057&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_ob8dto" data-idx="14">
            <div class="list-item-header">
              <span class="list-item-title">PAR1</span>
              <span class="status faste">‚ö° Faste</span>
            </div>
            <div class="list-item-meta">
              <span>NTT DATA ¬∑ BY-VINCI</span>
              <span>Le Coudray-Montceaux</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">11‚ÄØ500‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_3chsce" data-idx="15">
            <div class="list-item-header">
              <span class="list-item-title">PAR3</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>DATA4 ¬∑ BY</span>
              <span>Nozay</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ630‚ÄØ346&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_115ak0" data-idx="16">
            <div class="list-item-header">
              <span class="list-item-title">PASS2</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>EQUINIX ¬∑ VINCI</span>
              <span>Meudon</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">570‚ÄØ213&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_uckr9t" data-idx="17">
            <div class="list-item-header">
              <span class="list-item-title">SEGRO BONNEUIL</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>SEGRO ¬∑ BY-VINCI</span>
              <span>Bonneuil-sur-Marne</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ000‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_p6qzoa" data-idx="18">
            <div class="list-item-header">
              <span class="list-item-title">Telehouse</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>TELEHOUSE ¬∑ VINCI</span>
              <span>Paris 13e</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">495‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        </div>
      <div class="total-bar">
        <span>Total</span>
        <strong id="totalAmount">63‚ÄØ115‚ÄØ846&nbsp;‚Ç¨</strong>
      </div>
    </div>
  </main>

  <!-- Mobile Sidebar -->
  <div class="mobile-sidebar" id="mobileSidebar">
    <div class="mobile-backdrop" id="mobileBackdrop"></div>
    <div class="mobile-sidebar-content">
      <div class="mobile-header">
        <span style="font-weight:600;">Liste des affaires</span>
        <button class="btn-icon" id="mobileClose">‚úï</button>
      </div>
      <div class="search-section">
        <div class="search-box">
          <input type="text" class="search-input" id="mobileSearchInput" placeholder="Rechercher...">
        </div>
        <div class="filter-pills">
          <span class="pill active" data-filter="Tous">Tous</span>
          <span class="pill gagne" data-filter="Gagn√©">‚úì Gagn√©</span>
          <span class="pill perdu" data-filter="Perdu">‚úï Perdu</span>
          <span class="pill encours" data-filter="En cours">‚ó∑ En cours</span>
          <span class="pill faste" data-filter="Faste">‚ö° Faste</span>
        </div>
      </div>
      <div class="list-container" id="mobileListContainer">
          <div class="list-item" data-id="dc_1767782424344_b4dmpu" data-idx="0">
            <div class="list-item-header">
              <span class="list-item-title">1&amp;2 - PAR2</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>COLT ¬∑ BY</span>
              <span>Villebon-sur-Yvette</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">5‚ÄØ000‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767783496738_gxdjiy" data-idx="1">
            <div class="list-item-header">
              <span class="list-item-title">Data center PAR 15 Dugny</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>Digital ¬∑ BY</span>
              <span>1 Avenue du 2√®me DB</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">1‚ÄØ762‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767783665882_h3x2aj" data-idx="2">
            <div class="list-item-header">
              <span class="list-item-title">DATA CENTER VSG Bardage</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>GOODMAN ¬∑ Mercury</span>
              <span>34 Rue Louis Armand, Villeneuve-Saint-Georges, 94190, France</span>
              <span class="responsable-badge">üë§ Maxime</span>
            </div>
            <div class="list-item-description">Bardage</div>
            
            <div class="list-item-footer">
              <span class="list-item-amount">11‚ÄØ685‚ÄØ363&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767783749178_075yoa" data-idx="3">
            <div class="list-item-header">
              <span class="list-item-title">DATA CENTER VSG Etancheit√©</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>GOODMAN ¬∑ Mercury</span>
              <span>34 Rue Louis Armand, Villeneuve-Saint-Georges, 94190, France</span>
              <span class="responsable-badge">üë§ Maxime</span>
            </div>
            <div class="list-item-description">Etanch√©it√©</div>
            
            <div class="list-item-footer">
              <span class="list-item-amount">7‚ÄØ573‚ÄØ840&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767969607910_t33kfl" data-idx="4">
            <div class="list-item-header">
              <span class="list-item-title">DATA HILLS 3</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>HILLS ¬∑ Vinci</span>
              <span>Aulnay-sous-Bois</span>
              <span class="responsable-badge">üë§ Richad</span>
            </div>
            <div class="list-item-description">Fa√ßade/Couverture</div>
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ250‚ÄØ786&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_2vsynb" data-idx="5">
            <div class="list-item-header">
              <span class="list-item-title">DATA VELIZY</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>Nation Data Center ¬∑ BY</span>
              <span>V√©lizy-Villacoublay</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ275‚ÄØ398&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_1ddfqs" data-idx="6">
            <div class="list-item-header">
              <span class="list-item-title">Global Switch - Est</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>GLOBAL SWITCH ¬∑ BY</span>
              <span>Clichy</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">410‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_lmizhn" data-idx="7">
            <div class="list-item-header">
              <span class="list-item-title">Interxion PAR 10 &amp; 11</span>
              <span class="status perdu">‚úï Perdu</span>
            </div>
            <div class="list-item-meta">
              <span>INTERXION ¬∑ BY</span>
              <span>La Courneuve</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">-</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_p25gp8" data-idx="8">
            <div class="list-item-header">
              <span class="list-item-title">Interxion PAR7</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>INTERXION ¬∑ BY</span>
              <span>La Courneuve</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">1‚ÄØ500‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_zuksre" data-idx="9">
            <div class="list-item-header">
              <span class="list-item-title">PA10</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>EQUINIX ¬∑ BY</span>
              <span>Saint-Denis</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">14‚ÄØ541&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_bluynv" data-idx="10">
            <div class="list-item-header">
              <span class="list-item-title">PA14</span>
              <span class="status perdu">‚úï Perdu</span>
            </div>
            <div class="list-item-meta">
              <span>EQUINIX ¬∑ BY</span>
              <span>Aubervilliers</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ945‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_9glssy" data-idx="11">
            <div class="list-item-header">
              <span class="list-item-title">PA15</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>EQUINIX ¬∑ BY</span>
              <span>Meudon</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">7‚ÄØ079‚ÄØ169&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_km8rig" data-idx="12">
            <div class="list-item-header">
              <span class="list-item-title">PAR01</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>GOODMAN ¬∑ BY</span>
              <span>Tremblay-en-France</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ511‚ÄØ133&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_lg29xn" data-idx="13">
            <div class="list-item-header">
              <span class="list-item-title">PAR03</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>MICROSOFT ¬∑ BY</span>
              <span>V√©lizy-Villacoublay</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">913‚ÄØ057&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_ob8dto" data-idx="14">
            <div class="list-item-header">
              <span class="list-item-title">PAR1</span>
              <span class="status faste">‚ö° Faste</span>
            </div>
            <div class="list-item-meta">
              <span>NTT DATA ¬∑ BY-VINCI</span>
              <span>Le Coudray-Montceaux</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">11‚ÄØ500‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_3chsce" data-idx="15">
            <div class="list-item-header">
              <span class="list-item-title">PAR3</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>DATA4 ¬∑ BY</span>
              <span>Nozay</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ630‚ÄØ346&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_115ak0" data-idx="16">
            <div class="list-item-header">
              <span class="list-item-title">PASS2</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>EQUINIX ¬∑ VINCI</span>
              <span>Meudon</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">570‚ÄØ213&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_uckr9t" data-idx="17">
            <div class="list-item-header">
              <span class="list-item-title">SEGRO BONNEUIL</span>
              <span class="status encours">‚ó∑ En cours</span>
            </div>
            <div class="list-item-meta">
              <span>SEGRO ¬∑ BY-VINCI</span>
              <span>Bonneuil-sur-Marne</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">2‚ÄØ000‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        
          <div class="list-item" data-id="dc_1767782424344_p6qzoa" data-idx="18">
            <div class="list-item-header">
              <span class="list-item-title">Telehouse</span>
              <span class="status gagne">‚úì Gagn√©</span>
            </div>
            <div class="list-item-meta">
              <span>TELEHOUSE ¬∑ VINCI</span>
              <span>Paris 13e</span>
              
            </div>
            
            
            <div class="list-item-footer">
              <span class="list-item-amount">495‚ÄØ000&nbsp;‚Ç¨</span>
              <div class="list-item-actions">
                
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        </div>
      <div class="total-bar">
        <span>Total</span>
        <strong id="mobileTotalAmount">63‚ÄØ115‚ÄØ846&nbsp;‚Ç¨</strong>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="modalTitle">Nouvelle affaire</span>
        <button class="btn-icon" id="modalClose">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Affaires *</label>
            <input type="text" class="form-input" id="mAffaires" required="">
          </div>
          <div class="form-group">
            <label class="form-label">MOA *</label>
            <input type="text" class="form-input" id="mClient" required="">
          </div>
          <div class="form-group full">
            <label class="form-label">Description / Lot</label>
            <input type="text" class="form-input" id="mDescription" placeholder="Ex: Lot CVC, Lot Plomberie, √âtanch√©it√©...">
          </div>
          <div class="form-group">
            <label class="form-label">EG</label>
            <input type="text" class="form-input" id="mEG" placeholder="BY, VINCI...">
          </div>
          <div class="form-group">
            <label class="form-label">MOE</label>
            <input type="text" class="form-input" id="mArchitect">
          </div>
          <div class="form-group full">
            <label class="form-label">Adresse</label>
            <div style="display:flex;gap:6px;">
              <input type="text" class="form-input" id="mAdresse" style="flex:1">
              <button type="button" class="geocode-btn" id="geocodeBtn" title="Trouver les coordonn√©es">üìç G√©oloc</button>
            </div>
          </div>
          <div class="form-group full">
            <label class="form-label">Site SMAC</label>
            <div class="chips-select" id="mSmacChips">
              <button type="button" class="chip" data-value="PN2">PN2</button>
              <button type="button" class="chip" data-value="ANTONY">Antony</button>
              <button type="button" class="chip" data-value="GENNEVILLIERS">Gennevilliers</button>
              <button type="button" class="chip" data-value="PARIS">Paris</button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Date pr√©visionnelle</label>
            <input type="date" class="form-input" id="mDate">
          </div>
          <div class="form-group">
            <label class="form-label">Statut</label>
            <select class="form-select" id="mStatut">
              <option>Gagn√©</option>
              <option>Perdu</option>
              <option selected="">En cours</option>
              <option>Faste</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Montant (‚Ç¨)</label>
            <input type="text" class="form-input" id="mMontant" placeholder="1 500 000">
          </div>
          <div class="form-group">
            <label class="form-label">Responsable</label>
            <input type="text" class="form-input" id="mResponsable" placeholder="Jean Dupont">
          </div>
          <div class="form-group">
            <label class="form-label">Latitude *</label>
            <input type="text" class="form-input" id="mLat" placeholder="48.85">
          </div>
          <div class="form-group">
            <label class="form-label">Longitude *</label>
            <input type="text" class="form-input" id="mLng" placeholder="2.35">
          </div>
          <div class="form-group full">
            <label class="form-label">Tags (Entr√©e pour ajouter)</label>
            <div class="tags-input-container" id="tagsContainer">
              <input type="text" class="tags-input" id="mTagsInput" placeholder="Ajouter un tag...">
            </div>
          </div>
          <div class="form-group full">
            <label class="form-label">Lien document</label>
            <input type="text" class="form-input" id="mLink" placeholder="https://drive.google.com/...">
          </div>
          <div class="form-group full">
            <label class="form-label">Notes</label>
            <textarea class="form-textarea" id="mNotes" placeholder="Notes suppl√©mentaires..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="modalCancel">Annuler</button>
        <button class="btn btn-primary" id="modalSave">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width:400px">
      <div class="modal-header">
        <span class="modal-title">Confirmer la suppression</span>
        <button class="btn-icon" id="confirmClose">‚úï</button>
      </div>
      <div class="modal-body">
        <p id="confirmText">Supprimer cette affaire ?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="confirmNo">Annuler</button>
        <button class="btn btn-primary" id="confirmYes" style="background:var(--rose)">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- Tab Modal (Add/Rename) -->
  <div class="modal-overlay" id="tabModal">
    <div class="modal" style="max-width:400px">
      <div class="modal-header">
        <span class="modal-title" id="tabModalTitle">Nouvel onglet</span>
        <button class="btn-icon" id="tabModalClose">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nom de l'onglet</label>
          <input type="text" class="form-input" id="tabNameInput" placeholder="Ex: Projets 2027, R√©novations...">
        </div>
        <div class="form-group" style="margin-top: 12px;">
          <label class="form-label">Couleur</label>
          <div style="display: flex; gap: 8px; margin-top: 4px;">
            <button type="button" class="color-btn" data-color="#3b82f6" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#3b82f6;cursor:pointer;"></button>
            <button type="button" class="color-btn" data-color="#8b5cf6" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#8b5cf6;cursor:pointer;"></button>
            <button type="button" class="color-btn" data-color="#22c55e" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#22c55e;cursor:pointer;"></button>
            <button type="button" class="color-btn" data-color="#f59e0b" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#f59e0b;cursor:pointer;"></button>
            <button type="button" class="color-btn" data-color="#f43f5e" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#f43f5e;cursor:pointer;"></button>
            <button type="button" class="color-btn" data-color="#06b6d4" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#06b6d4;cursor:pointer;"></button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="tabModalCancel">Annuler</button>
        <button class="btn btn-primary" id="tabModalSave">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Duplicate Modal (Choose Target Tab) -->
  <div class="modal-overlay" id="duplicateModal">
    <div class="modal" style="max-width:400px">
      <div class="modal-header">
        <span class="modal-title">üìã Dupliquer vers...</span>
        <button class="btn-icon" id="duplicateModalClose">‚úï</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 12px; color: var(--gray-500); font-size: 13px;">Choisissez l'onglet de destination :</p>
        <div id="duplicateTabList" class="duplicate-tab-list">
          <!-- Tabs will be rendered here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="duplicateModalCancel">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Set Password Modal -->
  <div class="modal-overlay" id="setPasswordModal">
    <div class="modal" style="max-width:400px">
      <div class="modal-header">
        <span class="modal-title" id="setPasswordTitle">üîí Prot√©ger l'onglet</span>
        <button class="btn-icon" id="setPasswordClose">‚úï</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: var(--gray-500); font-size: 13px;" id="setPasswordDesc">
          D√©finissez un mot de passe pour prot√©ger cet onglet. Les coll√®gues devront le saisir pour y acc√©der.
        </p>
        <div class="form-group">
          <label class="form-label">Mot de passe</label>
          <div class="password-input-container">
            <input type="password" class="form-input" id="newPasswordInput" placeholder="Entrez un mot de passe...">
            <button type="button" class="password-toggle" id="toggleNewPassword">üëÅÔ∏è</button>
          </div>
          <div class="password-strength">
            <div class="password-strength-bar" id="passwordStrengthBar"></div>
          </div>
        </div>
        <div class="form-group" style="margin-top: 12px;">
          <label class="form-label">Confirmer le mot de passe</label>
          <div class="password-input-container">
            <input type="password" class="form-input" id="confirmPasswordInput" placeholder="Confirmez le mot de passe...">
            <button type="button" class="password-toggle" id="toggleConfirmPassword">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="unlock-hint">
          <span>üí°</span>
          <span>Le mot de passe sera demand√© √† chaque session.</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="setPasswordCancel">Annuler</button>
        <button class="btn btn-primary" id="setPasswordSave">üîí Prot√©ger</button>
      </div>
    </div>
  </div>

  <!-- Unlock Password Modal -->
  <div class="modal-overlay" id="unlockModal">
    <div class="modal" style="max-width:380px">
      <div class="modal-header">
        <span class="modal-title">üîê Onglet prot√©g√©</span>
        <button class="btn-icon" id="unlockModalClose">‚úï</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: var(--gray-500); font-size: 13px;">
          Cet onglet est prot√©g√© par mot de passe.
        </p>
        <div class="form-group">
          <label class="form-label">Mot de passe</label>
          <div class="password-input-container">
            <input type="password" class="form-input" id="unlockPasswordInput" placeholder="Entrez le mot de passe...">
            <button type="button" class="password-toggle" id="toggleUnlockPassword">üëÅÔ∏è</button>
          </div>
        </div>
        <p id="unlockError" style="color: var(--rose); font-size: 12px; margin-top: 8px; display: none;">
          ‚ùå Mot de passe incorrect
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="unlockModalCancel">Annuler</button>
        <button class="btn btn-primary" id="unlockModalSubmit">üîì D√©verrouiller</button>
      </div>
    </div>
  </div>

  <!-- Remove Protection Modal -->
  <div class="modal-overlay" id="removeProtectionModal">
    <div class="modal" style="max-width:380px">
      <div class="modal-header">
        <span class="modal-title">üîì Retirer la protection</span>
        <button class="btn-icon" id="removeProtectionClose">‚úï</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: var(--gray-500); font-size: 13px;">
          Entrez le mot de passe actuel pour retirer la protection de cet onglet.
        </p>
        <div class="form-group">
          <label class="form-label">Mot de passe actuel</label>
          <div class="password-input-container">
            <input type="password" class="form-input" id="removeProtectionPassword" placeholder="Entrez le mot de passe...">
            <button type="button" class="password-toggle" id="toggleRemovePassword">üëÅÔ∏è</button>
          </div>
        </div>
        <p id="removeProtectionError" style="color: var(--rose); font-size: 12px; margin-top: 8px; display: none;">
          ‚ùå Mot de passe incorrect
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="removeProtectionCancel">Annuler</button>
        <button class="btn btn-primary" id="removeProtectionSubmit" style="background: var(--orange);">üîì Retirer</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal-overlay" id="helpModal">
    <div class="modal" style="max-width:450px">
      <div class="modal-header">
        <span class="modal-title">‚å®Ô∏è Raccourcis &amp; Aide</span>
        <button class="btn-icon" id="helpClose">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 16px;">
          <strong style="color: var(--red);">üí° Astuces :</strong>
          <ul style="font-size: 13px; margin-top: 8px; padding-left: 20px; color: var(--gray-700);">
            <li>Glissez-d√©posez les onglets pour les r√©organiser</li>
            <li>Cliquez sur üîí pour prot√©ger un onglet par mot de passe</li>
          </ul>
        </div>
        <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 16px;font-size:13px;">
          <span class="kbd">N</span><span>Nouvelle affaire</span>
          <span class="kbd">R</span><span>Actualiser les donn√©es</span>
          <span class="kbd">E</span><span>Export Excel</span>
          <span class="kbd">P</span><span>Export PDF</span>
          <span class="kbd">/</span><span>Focus recherche</span>
          <span class="kbd">√âchap</span><span>Fermer les fen√™tres</span>
          <span class="kbd">1-5</span><span>Filtrer par statut</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="helpOk">OK</button>
      </div>
    </div>
  </div>

  <script>
    /* Supabase Configuration */
    const SUPABASE_URL = 'https://kaawdguztacoagfhhcgz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthYXdkZ3V6dGFjb2FnZmhoY2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NzgwNDYsImV4cCI6MjA4MzM1NDA0Nn0.XBNbYTrJkolGF6rZpoMZD5EwH068PCMqd_eiq7OCypA';

    /* CDN URLs */
    const CDN = {
      leafletCSS: ['https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css'],
      leafletJS: ['https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'],
      clusterCSS: ['https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css'],
      clusterDefaultCSS: ['https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css'],
      clusterJS: ['https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'],
      jsPDF: ['https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'],
      autoTable: ['https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js'],
      sheetJS: ['https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js']
    };

    /* Loaders */
    const injectCSS = urls => new Promise(res => {
      let i = 0;
      (function next() {
        if (i >= urls.length) return res(false);
        const l = document.createElement('link');
        l.rel = 'stylesheet'; l.href = urls[i++];
        l.onload = () => res(true); l.onerror = next;
        document.head.appendChild(l);
      })();
    });

    const injectJS = urls => new Promise(res => {
      let i = 0;
      (function next() {
        if (i >= urls.length) return res(false);
        const s = document.createElement('script');
        s.src = urls[i++]; s.async = true;
        s.onload = () => res(true); s.onerror = next;
        document.body.appendChild(s);
      })();
    });

    /* Utils */
    const escapeHTML = str => String(str ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const normalize = s => (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    
    const parseMontant = s => {
      if (!s || s === '-') return NaN;
      let t = s.toString().trim().toLowerCase().replace(/\s/g,'');
      let mul = 1;
      if (t.endsWith('k')) { mul = 1e3; t = t.slice(0,-1); }
      if (t.endsWith('m')) { mul = 1e6; t = t.slice(0,-1); }
      t = t.replace(/[^\d,.-]/g, '').replace(',', '.');
      const v = parseFloat(t);
      return isNaN(v) ? NaN : v * mul;
    };

    const nfEUR = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    const displayMontant = m => { const n = parseMontant(m); return Number.isFinite(n) ? nfEUR.format(n) : (m || '-'); };
    const formatDateStamp = () => { const d = new Date(); const pad = n => String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const parseCoord = v => { const s = String(v ?? '').trim().replace(',', '.'); return parseFloat(s) || NaN; };
    const parseDateISO = v => { const d = new Date(v); return Number.isFinite(d.getTime()) ? d.getTime() : NaN; };
    const formatDateFR = v => { const t = parseDateISO(v); if (isNaN(t)) return v || '-'; const d = new Date(t); const pad = n => String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`; };
    const makeId = () => 'dc_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);

    /* Toast Notifications */
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    /* Password Hashing (Simple hash that works everywhere) */
    function hashPassword(password) {
      // Simple but effective hash function (works on file://, http://, https://)
      const str = password + 'smac_salt_2024_secure';
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      // Make it longer and more complex
      let result = Math.abs(hash).toString(16);
      for (let i = 0; i < 3; i++) {
        hash = ((hash << 5) - hash) + (hash >> 3);
        result += Math.abs(hash).toString(16);
      }
      return result;
    }

    function getPasswordStrength(password) {
      if (!password) return '';
      let strength = 0;
      if (password.length >= 6) strength++;
      if (password.length >= 10) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;
      
      if (strength <= 2) return 'weak';
      if (strength <= 3) return 'medium';
      return 'strong';
    }

    /* Protection Modal Functions */
    function openSetPasswordModal(tabId) {
      const masterCodeInput = prompt('üîê Code de gestion requis :');
      if (!masterCodeInput) return showToast('Annul√©', 'info');
      if (masterCodeInput !== MASTER_CODE) return showToast('‚ùå Code incorrect', 'error');
      
      protectingTabId = tabId;
      document.getElementById('newPasswordInput').value = '';
      document.getElementById('confirmPasswordInput').value = '';
      document.getElementById('passwordStrengthBar').className = 'password-strength-bar';
      document.getElementById('setPasswordModal').classList.add('open');
      document.getElementById('newPasswordInput').focus();
    }

    function closeSetPasswordModal() {
      document.getElementById('setPasswordModal').classList.remove('open');
      protectingTabId = null;
    }

    async function saveTabPassword() {
      const password = document.getElementById('newPasswordInput').value;
      const confirm = document.getElementById('confirmPasswordInput').value;
      
      if (!password) {
        showToast('Veuillez entrer un mot de passe.', 'error');
        return;
      }
      
      if (password.length < 4) {
        showToast('Le mot de passe doit faire au moins 4 caract√®res.', 'error');
        return;
      }
      
      if (password !== confirm) {
        showToast('Les mots de passe ne correspondent pas.', 'error');
        return;
      }
      
      const tab = tabs.find(t => t.id === protectingTabId);
      if (tab) {
        tab.passwordHash = hashPassword(password);
        await saveTabsConfig();
        unlockedTabs.add(protectingTabId); // Auto-d√©verrouiller apr√®s d√©finition
        renderTabs();
        showToast(`üîí "${tab.name}" prot√©g√© ! (Rafra√Æchir pour verrouiller)`, 'success');
      }
      
      closeSetPasswordModal();
    }

    /* Unlock Modal Functions */
    function openUnlockModal(tabId) {
      unlockingTabId = tabId;
      document.getElementById('unlockPasswordInput').value = '';
      document.getElementById('unlockError').style.display = 'none';
      document.getElementById('unlockModal').classList.add('open');
      document.getElementById('unlockPasswordInput').focus();
    }

    function closeUnlockModal() {
      document.getElementById('unlockModal').classList.remove('open');
      unlockingTabId = null;
    }

    async function submitUnlock() {
      const password = document.getElementById('unlockPasswordInput').value;
      const tab = tabs.find(t => t.id === unlockingTabId);
      
      if (!tab) return;
      
      const hash = hashPassword(password);
      
      if (hash === tab.passwordHash) {
        unlockedTabs.add(unlockingTabId);
        closeUnlockModal();
        switchTab(unlockingTabId);
        showToast(`Onglet "${tab.name}" d√©verrouill√© ! üîì`, 'success');
      } else {
        document.getElementById('unlockError').style.display = 'block';
        document.getElementById('unlockPasswordInput').value = '';
        document.getElementById('unlockPasswordInput').focus();
      }
    }

    /* Remove Protection Modal Functions */
    function openRemoveProtectionModal(tabId) {
      const masterCodeInput = prompt('üîê Code de gestion requis :');
      if (!masterCodeInput) return showToast('Annul√©', 'info');
      if (masterCodeInput !== MASTER_CODE) return showToast('‚ùå Code incorrect', 'error');
      
      removingProtectionTabId = tabId;
      document.getElementById('removeProtectionPassword').value = '';
      document.getElementById('removeProtectionError').style.display = 'none';
      document.getElementById('removeProtectionModal').classList.add('open');
      document.getElementById('removeProtectionPassword').focus();
    }

    function closeRemoveProtectionModal() {
      document.getElementById('removeProtectionModal').classList.remove('open');
      removingProtectionTabId = null;
    }

    async function submitRemoveProtection() {
      const password = document.getElementById('removeProtectionPassword').value;
      const tab = tabs.find(t => t.id === removingProtectionTabId);
      
      if (!tab) return;
      
      const hash = hashPassword(password);
      
      if (hash === tab.passwordHash) {
        delete tab.passwordHash;
        unlockedTabs.delete(removingProtectionTabId);
        await saveTabsConfig();
        renderTabs();
        closeRemoveProtectionModal();
        showToast(`Protection retir√©e de "${tab.name}" üîì`, 'success');
      } else {
        document.getElementById('removeProtectionError').style.display = 'block';
        document.getElementById('removeProtectionPassword').value = '';
        document.getElementById('removeProtectionPassword').focus();
      }
    }

    function isTabLocked(tabId) {
      const tab = tabs.find(t => t.id === tabId);
      return tab?.passwordHash && !unlockedTabs.has(tabId);
    }

    function isTabProtected(tabId) {
      const tab = tabs.find(t => t.id === tabId);
      return !!tab?.passwordHash;
    }

    /* Default Data */
    const defaultDataDC = [
      {affaires:"1&2 - PAR2", client:"COLT", eg:"BY", architect:"RBA", adresse:"Villebon-sur-Yvette", smac:"", datePrevisionnelle:"", statut:"Gagn√©", montant:"5 000 000 ‚Ç¨", coords:[48.69185845097801, 2.219128539789481]},
      {affaires:"PAR03", client:"MICROSOFT", eg:"BY", architect:"RBA", adresse:"V√©lizy-Villacoublay", smac:"", datePrevisionnelle:"", statut:"Gagn√©", montant:"913 057 ‚Ç¨", coords:[48.784326576119696, 2.2091410968477154]},
      {affaires:"Global Switch - Est", client:"GLOBAL SWITCH", eg:"BY", architect:"APL", adresse:"Clichy", smac:"", datePrevisionnelle:"", statut:"Gagn√©", montant:"410 000 ‚Ç¨", coords:[48.89962692207227, 2.2960704688876863]},
      {affaires:"PA10", client:"EQUINIX", eg:"BY", architect:"RBA", adresse:"Saint-Denis", smac:"", datePrevisionnelle:"", statut:"Gagn√©", montant:"14 541 ‚Ç¨", coords:[48.927313927005734, 2.350674512495238]},
      {affaires:"Telehouse", client:"TELEHOUSE", eg:"VINCI", architect:"AAMH ASSOCIES", adresse:"Paris 13e", smac:"", datePrevisionnelle:"", statut:"Gagn√©", montant:"495 000 ‚Ç¨", coords:[48.8564370470459, 2.38353062630346]},
      {affaires:"Interxion PAR7", client:"INTERXION", eg:"BY", architect:"DK ARCHITECTES", adresse:"La Courneuve", smac:"", datePrevisionnelle:"", statut:"Gagn√©", montant:"1 500 000 ‚Ç¨", coords:[48.92530651461756, 2.401494431606759]},
      {affaires:"PA14", client:"EQUINIX", eg:"BY", architect:"RBA", adresse:"Aubervilliers", smac:"", datePrevisionnelle:"", statut:"Perdu", montant:"2 945 000 ‚Ç¨", coords:[48.908908655451164, 2.3728223956227543]},
      {affaires:"Interxion PAR 10 & 11", client:"INTERXION", eg:"BY", architect:"DK ARCHITECTES", adresse:"La Courneuve", smac:"", datePrevisionnelle:"", statut:"Perdu", montant:"-", coords:[48.92776437259542, 2.397265110647607]},
      {affaires:"SEGRO BONNEUIL", client:"SEGRO", eg:"BY-VINCI", architect:"RBA", adresse:"Bonneuil-sur-Marne", smac:"", datePrevisionnelle:"", statut:"En cours", montant:"2 000 000 ‚Ç¨", coords:[48.76931916868814, 2.4948702109577447]},
      {affaires:"PASS2", client:"EQUINIX", eg:"VINCI", architect:"RBA", adresse:"Meudon", smac:"", datePrevisionnelle:"", statut:"En cours", montant:"570 213 ‚Ç¨", coords:[48.78869514855185, 2.2154677416418247]},
      {affaires:"DATA VILLENEUVE", client:"GOODMAN", eg:"BY-EIFFAGE", architect:"RBA", adresse:"Villeneuve-Saint-Georges", smac:"", datePrevisionnelle:"", statut:"En cours", montant:"-", coords:[48.76129354753436, 2.4491614262989443]},
      {affaires:"PAR1", client:"NTT DATA", eg:"BY-VINCI", architect:"HYPHEN", adresse:"Le Coudray-Montceaux", smac:"", datePrevisionnelle:"", statut:"Faste", montant:"11 500 000 ‚Ç¨", coords:[48.57108084757299, 2.4643250379359993]},
      {affaires:"DATA HILLS 3", client:"HILLS", eg:"VINCI", architect:"RBA", adresse:"Aulnay-sous-Bois", smac:"", datePrevisionnelle:"", statut:"En cours", montant:"-", coords:[48.970329166784175, 2.498289028922746]},
      {affaires:"PA15", client:"EQUINIX", eg:"BY", architect:"RBA", adresse:"Meudon", smac:"", datePrevisionnelle:"", statut:"En cours", montant:"7 079 169 ‚Ç¨", coords:[48.78864189170742, 2.212410539794085]},
      {affaires:"PAR3", client:"DATA4", eg:"BY", architect:"IF ARCHITECTES", adresse:"Nozay", smac:"", datePrevisionnelle:"", statut:"En cours", montant:"2 630 346 ‚Ç¨", coords:[48.66884520433203, 2.2376156970706473]},
      {affaires:"PAR01", client:"GOODMAN", eg:"BY", architect:"A26 BLM", adresse:"Tremblay-en-France", smac:"", datePrevisionnelle:"", statut:"En cours", montant:"2 511 133 ‚Ç¨", coords:[48.968398055972706, 2.5689678923018984]},
      {affaires:"DATA VELIZY", client:"Nation Data Center", eg:"BY", architect:"Silvio d'Ascia Architecture", adresse:"V√©lizy-Villacoublay", smac:"", datePrevisionnelle:"", statut:"En cours", montant:"2 275 398 ‚Ç¨", coords:[48.78344102692218, 2.213381055135426]}
    ];

    const defaultDataProj = [
      {affaires:"Projet Alpha 2026", client:"CLIENT A", eg:"BY", architect:"Architecte X", adresse:"Paris 15e", smac:"PARIS", datePrevisionnelle:"2026-03-15", statut:"En cours", montant:"3 500 000 ‚Ç¨", coords:[48.8400, 2.2900]}
    ];

    /* State */
    const MASTER_CODE = 'Villepinte'; // Code ma√Ætre pour prot√©ger/supprimer des onglets
    let tabs = [
      { id: 'datacenter', name: 'Data-Centers', color: '#3b82f6' },
      { id: 'projets', name: 'Projets Chiffr√©s 2026', color: '#8b5cf6' }
    ];
    let dataByTab = {};
    let currentTab = 'datacenter';
    let currentList = [];
    let currentFilter = 'Tous';
    let currentSort = 'name';
    let currentQuery = '';
    let map, markerCluster;
    const markerByIndex = new Map();
    let editingId = null;
    let deletingIdx = null;
    let isSaving = false;
    let tabModalMode = 'add';
    let renamingTabId = null;
    let currentTags = [];
    let selectedTabColor = '#3b82f6';
    let duplicatingItemId = null;
    let protectingTabId = null;
    let unlockingTabId = null;
    let removingProtectionTabId = null;
    const unlockedTabs = new Set(); // Onglets d√©verrouill√©s pendant cette session

    /* Drag & Drop State */
    let draggedTab = null;
    let dropTarget = null;

    /* Geocode */
    async function geocodeAddress(address) {
      if (!address) return null;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', France')}&limit=1`);
        const data = await res.json();
        if (data && data[0]) {
          return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        }
      } catch (e) { console.error('Geocode error:', e); }
      return null;
    }

    /* Supabase API Functions */
    async function supabaseFetch(endpoint, options = {}) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
        ...options,
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': options.method === 'POST' ? 'return=representation' : undefined,
          ...options.headers
        }
      });
      return res;
    }

    async function loadFromCloud(tabName) {
      try {
        const res = await supabaseFetch(`affaires?tab=eq.${tabName}&select=data`);
        if (!res.ok) return null;
        const json = await res.json();
        if (json && json.length > 0 && json[0].data) {
          return json[0].data;
        }
        return null;
      } catch (e) {
        console.error('Erreur chargement:', e);
        return null;
      }
    }

    async function saveToCloud(tabName) {
      if (isSaving) return;
      isSaving = true;
      showSyncStatus('saving');
      
      const data = dataByTab[tabName];
      
      try {
        const checkRes = await supabaseFetch(`affaires?tab=eq.${tabName}&select=id`);
        const existing = await checkRes.json();
        
        if (existing && existing.length > 0) {
          await supabaseFetch(`affaires?tab=eq.${tabName}`, {
            method: 'PATCH',
            body: JSON.stringify({ data: data })
          });
        } else {
          await supabaseFetch('affaires', {
            method: 'POST',
            body: JSON.stringify({ tab: tabName, data: data })
          });
        }
        showSyncStatus('saved');
      } catch (e) {
        console.error('Erreur sauvegarde:', e);
        showSyncStatus('error');
      }
      isSaving = false;
    }

    async function loadTabsConfig() {
      try {
        const res = await supabaseFetch(`affaires?tab=eq._tabs_config&select=data`);
        if (!res.ok) return null;
        const json = await res.json();
        if (json && json.length > 0 && json[0].data) {
          return json[0].data;
        }
        return null;
      } catch (e) {
        console.error('Erreur chargement tabs config:', e);
        return null;
      }
    }

    async function saveTabsConfig() {
      try {
        const checkRes = await supabaseFetch(`affaires?tab=eq._tabs_config&select=id`);
        const existing = await checkRes.json();
        
        if (existing && existing.length > 0) {
          await supabaseFetch(`affaires?tab=eq._tabs_config`, {
            method: 'PATCH',
            body: JSON.stringify({ data: tabs })
          });
        } else {
          await supabaseFetch('affaires', {
            method: 'POST',
            body: JSON.stringify({ tab: '_tabs_config', data: tabs })
          });
        }
      } catch (e) {
        console.error('Erreur sauvegarde tabs config:', e);
      }
    }

    async function deleteTabData(tabId) {
      try {
        await supabaseFetch(`affaires?tab=eq.${tabId}`, { method: 'DELETE' });
      } catch (e) {
        console.error('Erreur suppression tab data:', e);
      }
    }

    /* Render Tabs with Drag & Drop */
    function renderTabs() {
      const wrapper = document.getElementById('tabsWrapper');
      if (!wrapper) return;
      
      wrapper.innerHTML = '';
      
      tabs.forEach((tab, index) => {
        const isProtected = !!tab.passwordHash;
        const isLocked = isTabLocked(tab.id);
        
        const btn = document.createElement('button');
        btn.className = `tab-btn ${tab.id === currentTab ? 'active' : ''} ${isLocked ? 'locked' : ''} ${isProtected ? 'protected' : ''}`;
        btn.dataset.tab = tab.id;
        btn.dataset.index = index;
        btn.draggable = true;
        btn.innerHTML = `
          <span class="drag-handle">‚ãÆ‚ãÆ</span>
          <span class="tab-dot" style="background:${tab.color}"></span>
          <span class="tab-name">${escapeHTML(tab.name)}</span>
          ${isProtected ? '<span class="lock-icon">' + (isLocked ? 'üîí' : 'üîì') + '</span>' : ''}
          <span class="tab-count">${dataByTab[tab.id]?.length || 0}</span>
          <span class="tab-actions">
            <button class="tab-action-btn lock ${isProtected ? 'has-password' : ''}" title="${isProtected ? 'Retirer la protection' : 'Prot√©ger'}">${isProtected ? 'üîì' : 'üîí'}</button>
            <button class="tab-action-btn rename" title="Renommer">‚úèÔ∏è</button>
            <button class="tab-action-btn delete" title="Supprimer">‚úï</button>
          </span>
        `;
        wrapper.appendChild(btn);
        
        // Tab click
        btn.addEventListener('click', (e) => {
          if (e.target.closest('.tab-action-btn')) return;
          
          // Si l'onglet est verrouill√©, demander le mot de passe
          if (isTabLocked(tab.id)) {
            openUnlockModal(tab.id);
            return;
          }
          
          switchTab(tab.id);
        });
        
        // Lock/Unlock click
        btn.querySelector('.lock').addEventListener('click', (e) => {
          e.stopPropagation();
          if (isProtected) {
            openRemoveProtectionModal(tab.id);
          } else {
            openSetPasswordModal(tab.id);
          }
        });
        
        // Rename click
        btn.querySelector('.rename').addEventListener('click', (e) => {
          e.stopPropagation();
          openTabModal('rename', tab.id);
        });
        
        // Delete click
        btn.querySelector('.delete').addEventListener('click', (e) => {
          e.stopPropagation();
          if (tabs.length <= 1) {
            showToast('Impossible de supprimer le dernier onglet.', 'error');
            return;
          }
          if (confirm(`Supprimer l'onglet "${tab.name}" et toutes ses affaires ?`)) {
            deleteTab(tab.id);
          }
        });

        // Drag & Drop Events
        btn.addEventListener('dragstart', handleDragStart);
        btn.addEventListener('dragend', handleDragEnd);
        btn.addEventListener('dragover', handleDragOver);
        btn.addEventListener('dragleave', handleDragLeave);
        btn.addEventListener('drop', handleDrop);
      });
    }

    /* Drag & Drop Handlers */
    function handleDragStart(e) {
      draggedTab = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.index);
      
      // Create a custom drag image
      const ghost = this.cloneNode(true);
      ghost.style.opacity = '0.8';
      ghost.style.position = 'absolute';
      ghost.style.top = '-1000px';
      document.body.appendChild(ghost);
      e.dataTransfer.setDragImage(ghost, 50, 20);
      setTimeout(() => ghost.remove(), 0);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.tab-btn').forEach(t => {
        t.classList.remove('drag-over', 'drag-over-left');
      });
      document.getElementById('dropIndicator').classList.remove('visible');
      draggedTab = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      if (this === draggedTab) return;
      
      const rect = this.getBoundingClientRect();
      const midX = rect.left + rect.width / 2;
      const indicator = document.getElementById('dropIndicator');
      
      if (e.clientX < midX) {
        this.classList.add('drag-over-left');
        this.classList.remove('drag-over');
        indicator.style.left = `${rect.left - 2}px`;
      } else {
        this.classList.add('drag-over');
        this.classList.remove('drag-over-left');
        indicator.style.left = `${rect.right - 1}px`;
      }
      
      indicator.style.top = `${rect.top + rect.height / 2 - 16}px`;
      indicator.classList.add('visible');
    }

    function handleDragLeave(e) {
      this.classList.remove('drag-over', 'drag-over-left');
    }

    function handleDrop(e) {
      e.preventDefault();
      
      if (this === draggedTab) return;
      
      const fromIndex = parseInt(draggedTab.dataset.index);
      let toIndex = parseInt(this.dataset.index);
      
      const rect = this.getBoundingClientRect();
      const midX = rect.left + rect.width / 2;
      
      // Adjust index based on drop position
      if (e.clientX > midX && toIndex < fromIndex) {
        toIndex++;
      } else if (e.clientX < midX && toIndex > fromIndex) {
        toIndex--;
      }
      
      // Reorder tabs
      const [movedTab] = tabs.splice(fromIndex, 1);
      tabs.splice(toIndex, 0, movedTab);
      
      // Save and re-render
      saveTabsConfig();
      renderTabs();
      showToast('Onglets r√©organis√©s !', 'success');
    }

    function switchTab(tabId) {
      currentTab = tabId;
      renderTabs();
      applyFilters();
    }

    /* Tab Modal */
    function openTabModal(mode, tabId = null) {
      tabModalMode = mode;
      renamingTabId = tabId;
      
      const title = document.getElementById('tabModalTitle');
      const input = document.getElementById('tabNameInput');
      
      // Reset color selection
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.style.border = '2px solid transparent';
      });
      
      if (mode === 'add') {
        title.textContent = 'Nouvel onglet';
        input.value = '';
        selectedTabColor = '#3b82f6';
      } else {
        title.textContent = "Renommer l'onglet";
        const tab = tabs.find(t => t.id === tabId);
        input.value = tab?.name || '';
        selectedTabColor = tab?.color || '#3b82f6';
      }
      
      // Highlight selected color
      const selectedBtn = document.querySelector(`.color-btn[data-color="${selectedTabColor}"]`);
      if (selectedBtn) selectedBtn.style.border = '2px solid var(--dark)';
      
      document.getElementById('tabModal').classList.add('open');
      input.focus();
    }

    function closeTabModal() {
      document.getElementById('tabModal').classList.remove('open');
    }

    async function saveTabModal() {
      const name = document.getElementById('tabNameInput').value.trim();
      if (!name) {
        showToast("Veuillez entrer un nom pour l'onglet.", 'error');
        return;
      }
      
      if (tabModalMode === 'add') {
        await addTab(name);
      } else {
        await renameTab(renamingTabId, name);
      }
      
      closeTabModal();
    }

    /* Tab Actions */
    const makeTabId = () => 'tab_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);

    async function addTab(name) {
      const newTab = {
        id: makeTabId(),
        name: name,
        color: selectedTabColor
      };
      tabs.push(newTab);
      dataByTab[newTab.id] = [];
      await saveTabsConfig();
      await saveToCloud(newTab.id);
      renderTabs();
      switchTab(newTab.id);
      showToast(`Onglet "${name}" cr√©√© !`, 'success');
    }

    async function renameTab(tabId, newName) {
      const tab = tabs.find(t => t.id === tabId);
      if (tab) {
        tab.name = newName;
        tab.color = selectedTabColor;
        await saveTabsConfig();
        renderTabs();
        showToast('Onglet renomm√© !', 'success');
      }
    }

    async function deleteTab(tabId) {
      const masterCodeInput = prompt('üîê Code de gestion requis :');
      if (!masterCodeInput) return showToast('Annul√©', 'info');
      if (masterCodeInput !== MASTER_CODE) return showToast('‚ùå Code incorrect', 'error');
      
      const idx = tabs.findIndex(t => t.id === tabId);
      if (idx > -1) {
        const tabName = tabs[idx].name;
        tabs.splice(idx, 1);
        delete dataByTab[tabId];
        await deleteTabData(tabId);
        await saveTabsConfig();
        
        if (currentTab === tabId) {
          currentTab = tabs[0]?.id || '';
        }
        renderTabs();
        applyFilters();
        showToast(`Onglet "${tabName}" supprim√©.`);
      }
    }

    function showSyncStatus(status) {
      const el = document.getElementById('syncStatus');
      if (!el) return;
      if (status === 'saving') {
        el.innerHTML = 'üîÑ Synchronisation...';
        el.style.color = '#f59e0b';
      } else if (status === 'saved') {
        el.innerHTML = '‚úì Synchronis√©';
        el.style.color = '#22c55e';
        setTimeout(() => { el.innerHTML = '‚òÅÔ∏è En ligne'; el.style.color = '#71717a'; }, 2000);
      } else if (status === 'error') {
        el.innerHTML = '‚ö†Ô∏è Erreur sync';
        el.style.color = '#f43f5e';
      }
    }

    /* Persistence */
    const persist = () => { saveToCloud(currentTab); };

    /* Migrate data */
    function migrateData(data) {
      return data.map(item => ({
        id: item.id || makeId(),
        affaires: item.affaires || '',
        client: item.client || '',
        description: item.description || '',
        eg: item.eg || '',
        architect: item.architect || '',
        adresse: item.adresse || '',
        smac: item.smac || '',
        datePrevisionnelle: item.datePrevisionnelle || '',
        statut: item.statut || 'En cours',
        montant: item.montant || '-',
        responsable: item.responsable || '',
        coords: item.coords || [48.8566, 2.3522],
        tags: item.tags || [],
        link: item.link || '',
        notes: item.notes || ''
      }));
    }

    function updateTabCounts() {
      renderTabs();
    }

    /* Filter & Sort */
    function applyFilters() {
      const data = dataByTab[currentTab] || [];
      const fClient = (document.getElementById('fClient')?.value || '').toLowerCase();
      const fEG = (document.getElementById('fEG')?.value || '').toLowerCase();
      const fArchitect = (document.getElementById('fArchitect')?.value || '').toLowerCase();
      const fAdresse = (document.getElementById('fAdresse')?.value || '').toLowerCase();
      const minM = parseMontant(document.getElementById('minMontant')?.value);
      const maxM = parseMontant(document.getElementById('maxMontant')?.value);

      let filtered = data.filter(item => {
        if (currentFilter !== 'Tous' && item.statut !== currentFilter) return false;
        if (currentQuery) {
          const q = normalize(currentQuery);
          const searchable = normalize(`${item.affaires} ${item.client} ${item.eg} ${item.architect} ${item.adresse} ${item.responsable} ${(item.tags||[]).join(' ')}`);
          if (!searchable.includes(q)) return false;
        }
        if (fClient && !normalize(item.client).includes(fClient)) return false;
        if (fEG && !normalize(item.eg).includes(fEG)) return false;
        if (fArchitect && !normalize(item.architect).includes(fArchitect)) return false;
        if (fAdresse && !normalize(item.adresse).includes(fAdresse)) return false;
        const m = parseMontant(item.montant);
        if (!isNaN(minM) && (isNaN(m) || m < minM)) return false;
        if (!isNaN(maxM) && (isNaN(m) || m > maxM)) return false;
        return true;
      });

      // Sort
      filtered.sort((a, b) => {
        switch (currentSort) {
          case 'name': return (a.affaires || '').localeCompare(b.affaires || '');
          case 'name-desc': return (b.affaires || '').localeCompare(a.affaires || '');
          case 'amount-desc': return (parseMontant(b.montant) || 0) - (parseMontant(a.montant) || 0);
          case 'amount-asc': return (parseMontant(a.montant) || 0) - (parseMontant(b.montant) || 0);
          case 'date': return (parseDateISO(b.datePrevisionnelle) || 0) - (parseDateISO(a.datePrevisionnelle) || 0);
          default: return 0;
        }
      });

      currentList = filtered;
      renderList(filtered);
      renderMap(filtered);
      updateStats(filtered, data);
    }

    function updateStats(filtered, all) {
      document.getElementById('countDisplay').textContent = filtered.length;
      let total = 0;
      filtered.forEach(item => {
        const m = parseMontant(item.montant);
        if (!isNaN(m)) total += m;
      });
      document.getElementById('totalAmount').textContent = nfEUR.format(total);
      document.getElementById('mobileTotalAmount').textContent = nfEUR.format(total);

      // Status stats
      const stats = { 'Gagn√©': 0, 'Perdu': 0, 'En cours': 0, 'Faste': 0 };
      all.forEach(item => { if (stats[item.statut] !== undefined) stats[item.statut]++; });
      document.getElementById('statusStats').innerHTML = `
        <span style="color:#22c55e">‚úì${stats['Gagn√©']}</span>
        <span style="color:#f43f5e;margin-left:6px">‚úï${stats['Perdu']}</span>
        <span style="color:#f59e0b;margin-left:6px">‚ó∑${stats['En cours']}</span>
        <span style="color:#3b82f6;margin-left:6px">‚ö°${stats['Faste']}</span>
      `;
    }

    function renderList(items) {
      const container = document.getElementById('listContainer');
      const mobileContainer = document.getElementById('mobileListContainer');
      
      if (!items.length) {
        const empty = '<div style="padding:40px;text-align:center;color:var(--gray-500)">Aucune affaire trouv√©e</div>';
        container.innerHTML = empty;
        mobileContainer.innerHTML = empty;
        return;
      }

      const html = items.map((item, idx) => {
        const statusClass = item.statut === 'Gagn√©' ? 'gagne' : item.statut === 'Perdu' ? 'perdu' : item.statut === 'Faste' ? 'faste' : 'encours';
        const statusIcon = item.statut === 'Gagn√©' ? '‚úì' : item.statut === 'Perdu' ? '‚úï' : item.statut === 'Faste' ? '‚ö°' : '‚ó∑';
        
        return `
          <div class="list-item" data-id="${item.id}" data-idx="${idx}">
            <div class="list-item-header">
              <span class="list-item-title">${escapeHTML(item.affaires)}</span>
              <span class="status ${statusClass}">${statusIcon} ${item.statut}</span>
            </div>
            <div class="list-item-meta">
              <span>${escapeHTML(item.client)} ¬∑ ${escapeHTML(item.eg)}</span>
              <span>${escapeHTML(item.adresse)}</span>
              ${item.responsable ? `<span class="responsable-badge">üë§ ${escapeHTML(item.responsable)}</span>` : ''}
            </div>
            ${item.description ? `<div class="list-item-description">${escapeHTML(item.description)}</div>` : ''}
            ${(item.tags && item.tags.length) ? `<div class="list-item-tags">${item.tags.map(t => `<span class="tag">${escapeHTML(t)}</span>`).join('')}</div>` : ''}
            <div class="list-item-footer">
              <span class="list-item-amount">${displayMontant(item.montant)}</span>
              <div class="list-item-actions">
                ${item.link ? `<button class="btn-icon link" title="Ouvrir document">üîó</button>` : ''}
                <button class="btn-icon duplicate" title="Dupliquer">üìã</button>
                <button class="btn-icon edit" title="Modifier">‚úèÔ∏è</button>
                <button class="btn-icon delete" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
      mobileContainer.innerHTML = html;

      // Add event listeners
      [container, mobileContainer].forEach(c => {
        c.querySelectorAll('.list-item').forEach(el => {
          el.addEventListener('click', (e) => {
            if (e.target.closest('.btn-icon')) return;
            const item = currentList[parseInt(el.dataset.idx)];
            if (item && map) {
              map.flyTo(item.coords, 14, { duration: 0.8 });
              const marker = markerByIndex.get(item.id);
              if (marker) marker.openPopup();
            }
          });

          el.querySelector('.edit')?.addEventListener('click', () => editItem(el.dataset.id));
          el.querySelector('.delete')?.addEventListener('click', () => askDelete(el.dataset.id));
          el.querySelector('.duplicate')?.addEventListener('click', () => duplicateItem(el.dataset.id));
          el.querySelector('.link')?.addEventListener('click', () => {
            const item = dataByTab[currentTab].find(i => i.id === el.dataset.id);
            if (item?.link) window.open(item.link, '_blank');
          });
        });
      });
    }

    /* Map Rendering */
    function renderMap(items) {
      if (!map || !markerCluster) return;
      markerCluster.clearLayers();
      markerByIndex.clear();

      items.forEach(item => {
        const lat = parseCoord(item.coords?.[0]);
        const lng = parseCoord(item.coords?.[1]);
        if (isNaN(lat) || isNaN(lng)) return;

        const color = item.statut === 'Gagn√©' ? '#22c55e' : item.statut === 'Perdu' ? '#f43f5e' : item.statut === 'Faste' ? '#3b82f6' : '#f59e0b';
        
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="width:24px;height:24px;background:${color};border:3px solid white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });

        const marker = L.marker([lat, lng], { icon });
        marker.bindPopup(`
          <div class="popup-content">
            <div class="popup-title">${escapeHTML(item.affaires)}</div>
            <div class="popup-client">${escapeHTML(item.client)} ¬∑ ${escapeHTML(item.eg)}</div>
            <div class="popup-amount">${displayMontant(item.montant)}</div>
          </div>
        `);
        
        markerCluster.addLayer(marker);
        markerByIndex.set(item.id, marker);
      });
    }

    /* CRUD Operations */
    function openModal() {
      document.getElementById('modal').classList.add('open');
      document.getElementById('mAffaires').focus();
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('open');
      editingId = null;
    }

    function clearModalForm() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Nouvelle affaire';
      ['mAffaires', 'mClient', 'mDescription', 'mEG', 'mArchitect', 'mAdresse', 'mDate', 'mMontant', 'mResponsable', 'mLat', 'mLng', 'mLink', 'mNotes'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.getElementById('mStatut').value = 'En cours';
      document.querySelectorAll('#mSmacChips .chip').forEach(c => c.classList.remove('active'));
      currentTags = [];
      renderTagsInput();
    }

    function editItem(id) {
      const item = dataByTab[currentTab].find(i => i.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Modifier l\'affaire';
      document.getElementById('mAffaires').value = item.affaires || '';
      document.getElementById('mClient').value = item.client || '';
      document.getElementById('mDescription').value = item.description || '';
      document.getElementById('mEG').value = item.eg || '';
      document.getElementById('mArchitect').value = item.architect || '';
      document.getElementById('mAdresse').value = item.adresse || '';
      document.getElementById('mDate').value = item.datePrevisionnelle || '';
      document.getElementById('mStatut').value = item.statut || 'En cours';
      document.getElementById('mMontant').value = item.montant || '';
      document.getElementById('mResponsable').value = item.responsable || '';
      document.getElementById('mLat').value = item.coords?.[0] || '';
      document.getElementById('mLng').value = item.coords?.[1] || '';
      document.getElementById('mLink').value = item.link || '';
      document.getElementById('mNotes').value = item.notes || '';
      
      document.querySelectorAll('#mSmacChips .chip').forEach(c => {
        c.classList.toggle('active', c.dataset.value === item.smac);
      });
      
      currentTags = item.tags || [];
      renderTagsInput();
      
      openModal();
    }

    function duplicateItem(id) {
      const item = dataByTab[currentTab].find(i => i.id === id);
      if (!item) return;
      
      duplicatingItemId = id;
      openDuplicateModal();
    }

    function openDuplicateModal() {
      const item = dataByTab[currentTab].find(i => i.id === duplicatingItemId);
      if (!item) return;
      
      const container = document.getElementById('duplicateTabList');
      container.innerHTML = '';
      
      tabs.forEach(tab => {
        const isCurrent = tab.id === currentTab;
        const isLocked = isTabLocked(tab.id);
        const isProtected = isTabProtected(tab.id);
        
        const btn = document.createElement('button');
        btn.className = `duplicate-tab-option ${isCurrent ? 'current' : ''} ${isLocked ? 'locked' : ''}`;
        btn.style.opacity = isLocked ? '0.5' : '1';
        btn.innerHTML = `
          <span class="tab-dot" style="background: ${tab.color}"></span>
          <div class="tab-info">
            <div class="tab-name">${escapeHTML(tab.name)} ${isProtected ? (isLocked ? 'üîí' : 'üîì') : ''}</div>
            <div class="tab-count">${dataByTab[tab.id]?.length || 0} affaires</div>
          </div>
          ${isCurrent ? '<span class="current-badge">Onglet actuel</span>' : ''}
          ${isLocked ? '<span class="current-badge" style="background: var(--orange-light); color: var(--orange);">Verrouill√©</span>' : ''}
        `;
        
        if (isLocked) {
          btn.addEventListener('click', () => {
            showToast('D√©verrouillez d\'abord cet onglet pour y dupliquer.', 'error');
          });
        } else {
          btn.addEventListener('click', () => performDuplicate(tab.id));
        }
        
        container.appendChild(btn);
      });
      
      document.getElementById('duplicateModal').classList.add('open');
    }

    function closeDuplicateModal() {
      document.getElementById('duplicateModal').classList.remove('open');
      duplicatingItemId = null;
    }

    async function performDuplicate(targetTabId) {
      const item = dataByTab[currentTab].find(i => i.id === duplicatingItemId);
      if (!item) return;
      
      const newItem = { 
        ...item, 
        id: makeId(), 
        affaires: item.affaires + ' (copie)' 
      };
      
      dataByTab[targetTabId].push(newItem);
      
      // Save to cloud
      await saveToCloud(targetTabId);
      
      updateTabCounts();
      
      if (targetTabId === currentTab) {
        applyFilters();
      }
      
      closeDuplicateModal();
      
      const targetTab = tabs.find(t => t.id === targetTabId);
      showToast(`Affaire dupliqu√©e vers "${targetTab.name}" !`, 'success');
    }

    function askDelete(id) {
      const item = dataByTab[currentTab].find(i => i.id === id);
      if (!item) return;
      
      deletingIdx = id;
      document.getElementById('confirmText').textContent = `Supprimer "${item.affaires}" ?`;
      document.getElementById('confirmModal').classList.add('open');
    }

    function closeConfirm() {
      document.getElementById('confirmModal').classList.remove('open');
      deletingIdx = null;
    }

    function confirmDelete() {
      if (!deletingIdx) return;
      
      const idx = dataByTab[currentTab].findIndex(i => i.id === deletingIdx);
      if (idx > -1) {
        dataByTab[currentTab].splice(idx, 1);
        persist();
        updateTabCounts();
        applyFilters();
        showToast('Affaire supprim√©e.');
      }
      closeConfirm();
    }

    function saveModal() {
      const affaires = document.getElementById('mAffaires').value.trim();
      const client = document.getElementById('mClient').value.trim();
      const lat = parseCoord(document.getElementById('mLat').value);
      const lng = parseCoord(document.getElementById('mLng').value);

      if (!affaires || !client) {
        showToast('Affaires et MOA sont obligatoires.', 'error');
        return;
      }
      if (isNaN(lat) || isNaN(lng)) {
        showToast('Coordonn√©es invalides.', 'error');
        return;
      }

      const smacChip = document.querySelector('#mSmacChips .chip.active');
      
      const itemData = {
        id: editingId || makeId(),
        affaires,
        client,
        description: document.getElementById('mDescription').value.trim(),
        eg: document.getElementById('mEG').value.trim(),
        architect: document.getElementById('mArchitect').value.trim(),
        adresse: document.getElementById('mAdresse').value.trim(),
        smac: smacChip?.dataset.value || '',
        datePrevisionnelle: document.getElementById('mDate').value,
        statut: document.getElementById('mStatut').value,
        montant: document.getElementById('mMontant').value.trim() || '-',
        responsable: document.getElementById('mResponsable').value.trim(),
        coords: [lat, lng],
        tags: currentTags,
        link: document.getElementById('mLink').value.trim(),
        notes: document.getElementById('mNotes').value.trim()
      };

      if (editingId) {
        const idx = dataByTab[currentTab].findIndex(i => i.id === editingId);
        if (idx > -1) dataByTab[currentTab][idx] = itemData;
      } else {
        dataByTab[currentTab].push(itemData);
      }

      persist();
      updateTabCounts();
      applyFilters();
      closeModal();
      showToast(editingId ? 'Affaire modifi√©e !' : 'Affaire cr√©√©e !', 'success');
    }

    /* Tags Input */
    function renderTagsInput() {
      const container = document.getElementById('tagsContainer');
      const input = document.getElementById('mTagsInput');
      container.innerHTML = '';
      currentTags.forEach(tag => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = tag;
        span.onclick = () => {
          currentTags = currentTags.filter(t => t !== tag);
          renderTagsInput();
        };
        container.appendChild(span);
      });
      container.appendChild(input);
    }

    function handleTagInput(e) {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const val = e.target.value.trim().replace(',', '');
        if (val && !currentTags.includes(val)) {
          currentTags.push(val);
          renderTagsInput();
        }
        e.target.value = '';
      }
    }

    /* Export Functions */
    function exportExcel() {
      if (typeof XLSX === 'undefined') {
        showToast('Chargement en cours...', 'error');
        return;
      }
      
      const data = currentList.map(item => ({
        'Affaires': item.affaires,
        'MOA': item.client,
        'Description': item.description,
        'EG': item.eg,
        'MOE': item.architect,
        'Adresse': item.adresse,
        'SMAC': item.smac,
        'Date': formatDateFR(item.datePrevisionnelle),
        'Statut': item.statut,
        'Montant': item.montant,
        'Responsable': item.responsable,
        'Tags': (item.tags || []).join(', '),
        'Latitude': item.coords?.[0],
        'Longitude': item.coords?.[1]
      }));
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Affaires');
      XLSX.writeFile(wb, `SMAC_Export_${formatDateStamp()}.xlsx`);
      showToast('Export Excel t√©l√©charg√© !', 'success');
    }

    function exportPDF() {
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        showToast('Chargement en cours...', 'error');
        return;
      }
      
      const { jsPDF } = jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      
      // Get current tab name
      const currentTabObj = tabs.find(t => t.id === currentTab);
      const tabName = currentTabObj ? currentTabObj.name : 'Data-Centers';
      
      // Header - Style SMAC avec rouge
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(225, 6, 0); // Rouge SMAC
      doc.text('SMAC - Cartographie des affaires', 14, 15);
      
      // Subtitle with tab info
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(100, 100, 100);
      const today = new Date();
      const dateStr = `${today.getDate().toString().padStart(2,'0')}/${(today.getMonth()+1).toString().padStart(2,'0')}/${today.getFullYear()}`;
      doc.text(`Onglet: ${tabName} | Export du ${dateStr} | ${currentList.length} affaire(s)`, 14, 21);
      
      // Fonction pour formater les montants proprement pour le PDF
      const formatMontantPDF = (m) => {
        const n = parseMontant(m);
        if (!Number.isFinite(n)) return m || '-';
        return n.toLocaleString('fr-FR').replace(/\s/g, ' ') + ' EUR';
      };
      
      // Table data
      const tableData = currentList.map(item => {
        const ville = item.adresse ? item.adresse.split(',')[0].trim() : '-';
        return [
          item.affaires || '-',
          ville,
          item.eg || '-',
          item.architect || '-',
          item.client || '-',
          item.description || '-',
          formatMontantPDF(item.montant),
          item.datePrevisionnelle ? formatDateFR(item.datePrevisionnelle) : '-'
        ];
      });
      
      // Calculate total
      const total = currentList.reduce((sum, item) => {
        const val = parseMontant(item.montant);
        return Number.isFinite(val) ? sum + val : sum;
      }, 0);
      
      // Add total row
      const totalFormatted = total.toLocaleString('fr-FR').replace(/\s/g, ' ') + ' EUR';
      tableData.push([
        'Total:', '', '', '', '', '',
        totalFormatted,
        ''
      ]);
      
      // Create table - Style SMAC avec header rouge
      doc.autoTable({
        startY: 27,
        head: [['Affaire', 'Ville', 'EG', 'MOE', 'MOA', 'Prestation', 'Montant', 'Date pr√©v.']],
        body: tableData,
        theme: 'grid',
        styles: { 
          fontSize: 8,
          cellPadding: 2.5,
          textColor: [30, 30, 30],
          lineWidth: 0.1,
          lineColor: [200, 200, 200]
        },
        headStyles: { 
          fillColor: [225, 6, 0], // Rouge SMAC
          textColor: [255, 255, 255],
          fontStyle: 'bold',
          halign: 'left'
        },
        bodyStyles: {
          fillColor: [255, 255, 255]
        },
        alternateRowStyles: {
          fillColor: [252, 252, 252]
        },
        columnStyles: {
          0: { cellWidth: 38 },
          1: { cellWidth: 40 },
          2: { cellWidth: 18 },
          3: { cellWidth: 32 },
          4: { cellWidth: 28 },
          5: { cellWidth: 38 },
          6: { cellWidth: 30, halign: 'right' },
          7: { cellWidth: 24 }
        },
        didParseCell: function(data) {
          if (data.row.index === tableData.length - 1) {
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fillColor = [255, 245, 245]; // Rouge tr√®s clair
          }
        },
        margin: { left: 14, right: 14 }
      });
      
      doc.save(`SMAC_${tabName}_${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}.pdf`);
      showToast('Export PDF t√©l√©charg√© !', 'success');
    }

    /* Initialize */
    document.addEventListener('DOMContentLoaded', async () => {
      // Load CSS
      await Promise.all([
        injectCSS(CDN.leafletCSS),
        injectCSS(CDN.clusterCSS),
        injectCSS(CDN.clusterDefaultCSS)
      ]);

      // Load JS
      await injectJS(CDN.leafletJS);
      await injectJS(CDN.clusterJS);

      // Load tabs config from cloud
      const cloudTabs = await loadTabsConfig();
      if (cloudTabs && Array.isArray(cloudTabs) && cloudTabs.length > 0) {
        tabs = cloudTabs;
        currentTab = tabs[0]?.id || 'datacenter';
      }

      // Load data for each tab
      for (const tab of tabs) {
        const cloudData = await loadFromCloud(tab.id);
        if (cloudData && Array.isArray(cloudData)) {
          dataByTab[tab.id] = migrateData(cloudData);
        } else {
          dataByTab[tab.id] = migrateData(tab.id === 'datacenter' ? defaultDataDC : defaultDataProj);
        }
      }

      renderTabs();

      // Initialize map
      map = L.map('map').setView([48.8566, 2.3522], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      markerCluster = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        maxClusterRadius: 50
      });
      map.addLayer(markerCluster);

      // Legend
      const legend = L.control({ position: 'bottomright' });
      legend.onAdd = () => {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <div class="legend-title">Statut</div>
          <div class="legend-item"><span class="legend-dot" style="background:#22c55e"></span> Gagn√©</div>
          <div class="legend-item"><span class="legend-dot" style="background:#f43f5e"></span> Perdu</div>
          <div class="legend-item"><span class="legend-dot" style="background:#f59e0b"></span> En cours</div>
          <div class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span> Faste</div>
        `;
        return div;
      };
      legend.addTo(map);

      // Initial render
      applyFilters();

      // Event Listeners
      document.getElementById('addTabBtn')?.addEventListener('click', () => openTabModal('add'));
      document.getElementById('tabModalClose')?.addEventListener('click', closeTabModal);
      document.getElementById('tabModalCancel')?.addEventListener('click', closeTabModal);
      document.getElementById('tabModalSave')?.addEventListener('click', saveTabModal);
      document.getElementById('tabNameInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveTabModal();
      });

      // Color buttons
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.color-btn').forEach(b => b.style.border = '2px solid transparent');
          btn.style.border = '2px solid var(--dark)';
          selectedTabColor = btn.dataset.color;
        });
      });

      // Search
      const searchInput = document.getElementById('searchInput');
      const mobileSearchInput = document.getElementById('mobileSearchInput');
      const debounce = (fn, delay) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), delay); }; };
      const doSearch = debounce(() => { 
        currentQuery = searchInput?.value || mobileSearchInput?.value || ''; 
        applyFilters(); 
      }, 200);
      searchInput?.addEventListener('input', doSearch);
      mobileSearchInput?.addEventListener('input', doSearch);

      // Sort
      document.getElementById('sortSelect')?.addEventListener('change', (e) => {
        currentSort = e.target.value;
        applyFilters();
      });

      // Filter Pills
      document.querySelectorAll('.filter-pills .pill').forEach(pill => {
        pill.addEventListener('click', () => {
          document.querySelectorAll('.filter-pills .pill').forEach(p => p.classList.remove('active'));
          document.querySelectorAll(`.pill[data-filter="${pill.dataset.filter}"]`).forEach(p => p.classList.add('active'));
          currentFilter = pill.dataset.filter;
          applyFilters();
        });
      });

      // Advanced Toggle
      document.getElementById('advancedToggle')?.addEventListener('click', () => {
        document.getElementById('advancedToggle').classList.toggle('open');
        document.getElementById('advancedPanel').classList.toggle('open');
      });

      document.getElementById('applyAdvanced')?.addEventListener('click', applyFilters);
      document.getElementById('resetAdvanced')?.addEventListener('click', () => {
        ['fClient', 'fEG', 'fArchitect', 'fAdresse', 'minMontant', 'maxMontant'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
        applyFilters();
      });
      document.getElementById('resetData')?.addEventListener('click', async () => {
        if (confirm('R√©initialiser les donn√©es de cet onglet ? Cela affectera tous les utilisateurs.')) {
          const defaults = currentTab === 'datacenter' ? defaultDataDC : defaultDataProj;
          dataByTab[currentTab] = migrateData(JSON.parse(JSON.stringify(defaults)));
          await saveToCloud(currentTab);
          updateTabCounts();
          applyFilters();
          showToast('Donn√©es r√©initialis√©es.');
        }
      });

      // Share
      document.getElementById('shareBtn')?.addEventListener('click', () => {
        const shareUrl = window.location.href.split('?')[0];
        if (navigator.clipboard) {
          navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('Lien copi√© !', 'success');
          });
        }
      });

      // Refresh
      document.getElementById('refreshBtn')?.addEventListener('click', async () => {
        const btn = document.getElementById('refreshBtn');
        btn.classList.add('refreshing');
        showSyncStatus('saving');
        
        const cloudTabs = await loadTabsConfig();
        if (cloudTabs && Array.isArray(cloudTabs)) tabs = cloudTabs;
        
        for (const tab of tabs) {
          const cloudData = await loadFromCloud(tab.id);
          if (cloudData && Array.isArray(cloudData)) {
            dataByTab[tab.id] = migrateData(cloudData);
          }
        }
        
        renderTabs();
        applyFilters();
        showSyncStatus('saved');
        btn.classList.remove('refreshing');
        showToast('Donn√©es actualis√©es !', 'success');
      });

      // Modal
      document.getElementById('addBtn')?.addEventListener('click', () => { clearModalForm(); openModal(); });
      document.getElementById('modalClose')?.addEventListener('click', closeModal);
      document.getElementById('modalCancel')?.addEventListener('click', closeModal);
      document.getElementById('modalSave')?.addEventListener('click', saveModal);

      // Chips
      document.querySelectorAll('#mSmacChips .chip').forEach(chip => {
        chip.addEventListener('click', () => chip.classList.toggle('active'));
      });

      // Confirm Modal
      document.getElementById('confirmClose')?.addEventListener('click', closeConfirm);
      document.getElementById('confirmNo')?.addEventListener('click', closeConfirm);
      document.getElementById('confirmYes')?.addEventListener('click', confirmDelete);

      // Duplicate Modal
      document.getElementById('duplicateModalClose')?.addEventListener('click', closeDuplicateModal);
      document.getElementById('duplicateModalCancel')?.addEventListener('click', closeDuplicateModal);

      // Set Password Modal
      document.getElementById('setPasswordClose')?.addEventListener('click', closeSetPasswordModal);
      document.getElementById('setPasswordCancel')?.addEventListener('click', closeSetPasswordModal);
      document.getElementById('setPasswordSave')?.addEventListener('click', saveTabPassword);
      
      document.getElementById('newPasswordInput')?.addEventListener('input', (e) => {
        const strength = getPasswordStrength(e.target.value);
        const bar = document.getElementById('passwordStrengthBar');
        bar.className = 'password-strength-bar ' + strength;
      });
      
      document.getElementById('newPasswordInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') document.getElementById('confirmPasswordInput').focus();
      });
      
      document.getElementById('confirmPasswordInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveTabPassword();
      });

      // Toggle password visibility
      document.getElementById('toggleNewPassword')?.addEventListener('click', () => {
        const input = document.getElementById('newPasswordInput');
        input.type = input.type === 'password' ? 'text' : 'password';
      });
      
      document.getElementById('toggleConfirmPassword')?.addEventListener('click', () => {
        const input = document.getElementById('confirmPasswordInput');
        input.type = input.type === 'password' ? 'text' : 'password';
      });
      
      document.getElementById('toggleUnlockPassword')?.addEventListener('click', () => {
        const input = document.getElementById('unlockPasswordInput');
        input.type = input.type === 'password' ? 'text' : 'password';
      });
      
      document.getElementById('toggleRemovePassword')?.addEventListener('click', () => {
        const input = document.getElementById('removeProtectionPassword');
        input.type = input.type === 'password' ? 'text' : 'password';
      });

      // Unlock Modal
      document.getElementById('unlockModalClose')?.addEventListener('click', closeUnlockModal);
      document.getElementById('unlockModalCancel')?.addEventListener('click', closeUnlockModal);
      document.getElementById('unlockModalSubmit')?.addEventListener('click', submitUnlock);
      document.getElementById('unlockPasswordInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') submitUnlock();
      });

      // Remove Protection Modal
      document.getElementById('removeProtectionClose')?.addEventListener('click', closeRemoveProtectionModal);
      document.getElementById('removeProtectionCancel')?.addEventListener('click', closeRemoveProtectionModal);
      document.getElementById('removeProtectionSubmit')?.addEventListener('click', submitRemoveProtection);
      document.getElementById('removeProtectionPassword')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') submitRemoveProtection();
      });

      // Export
      document.getElementById('exportExcel')?.addEventListener('click', exportExcel);
      document.getElementById('exportPdf')?.addEventListener('click', exportPDF);

      // Mobile
      document.getElementById('mobileMenuBtn')?.addEventListener('click', () => {
        document.getElementById('mobileSidebar').classList.add('open');
      });
      document.getElementById('mobileBackdrop')?.addEventListener('click', () => {
        document.getElementById('mobileSidebar').classList.remove('open');
      });
      document.getElementById('mobileClose')?.addEventListener('click', () => {
        document.getElementById('mobileSidebar').classList.remove('open');
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', e => {
        if (e.target.matches('input, textarea, select')) {
          if (e.key === 'Escape') {
            closeModal();
            closeConfirm();
            closeTabModal();
            closeDuplicateModal();
            closeSetPasswordModal();
            closeUnlockModal();
            closeRemoveProtectionModal();
            document.getElementById('helpModal')?.classList.remove('open');
            document.getElementById('mobileSidebar')?.classList.remove('open');
          }
          return;
        }
        
        switch(e.key) {
          case 'Escape':
            closeModal();
            closeConfirm();
            closeTabModal();
            closeDuplicateModal();
            closeSetPasswordModal();
            closeUnlockModal();
            closeRemoveProtectionModal();
            document.getElementById('helpModal')?.classList.remove('open');
            document.getElementById('mobileSidebar')?.classList.remove('open');
            break;
          case 'n': case 'N':
            clearModalForm();
            openModal();
            break;
          case 'r': case 'R':
            document.getElementById('refreshBtn')?.click();
            break;
          case 'e': case 'E':
            exportExcel();
            break;
          case 'p': case 'P':
            exportPDF();
            break;
          case '/':
            e.preventDefault();
            document.getElementById('searchInput')?.focus();
            break;
          case '?':
            document.getElementById('helpModal').classList.add('open');
            break;
          case '1':
            document.querySelector('.pill[data-filter="Tous"]')?.click();
            break;
          case '2':
            document.querySelector('.pill[data-filter="Gagn√©"]')?.click();
            break;
          case '3':
            document.querySelector('.pill[data-filter="Perdu"]')?.click();
            break;
          case '4':
            document.querySelector('.pill[data-filter="En cours"]')?.click();
            break;
          case '5':
            document.querySelector('.pill[data-filter="Faste"]')?.click();
            break;
        }
      });

      // Help modal
      document.getElementById('helpBtn')?.addEventListener('click', () => {
        document.getElementById('helpModal').classList.add('open');
      });
      document.getElementById('helpClose')?.addEventListener('click', () => {
        document.getElementById('helpModal').classList.remove('open');
      });
      document.getElementById('helpOk')?.addEventListener('click', () => {
        document.getElementById('helpModal').classList.remove('open');
      });

      // Geocode
      document.getElementById('geocodeBtn')?.addEventListener('click', async () => {
        const address = document.getElementById('mAdresse').value;
        if (!address) { showToast("Entrez d'abord une adresse", 'error'); return; }
        const btn = document.getElementById('geocodeBtn');
        btn.textContent = '‚è≥';
        btn.disabled = true;
        const coords = await geocodeAddress(address);
        if (coords) {
          document.getElementById('mLat').value = coords.lat.toFixed(6);
          document.getElementById('mLng').value = coords.lng.toFixed(6);
          btn.textContent = '‚úÖ';
          showToast('Coordonn√©es trouv√©es !', 'success');
        } else {
          btn.textContent = '‚ùå';
          showToast('Adresse non trouv√©e', 'error');
        }
        setTimeout(() => { btn.textContent = 'üìç G√©oloc'; btn.disabled = false; }, 2000);
      });

      // Tags input
      document.getElementById('mTagsInput')?.addEventListener('keydown', handleTagInput);

      // Preload export libs
      injectJS(CDN.sheetJS);
      injectJS(CDN.jsPDF).then(() => injectJS(CDN.autoTable));
    });
  </script>


<script src="./Cartographie SMAC mdp_files/leaflet.js.t√©l√©chargement" async=""></script><script src="./Cartographie SMAC mdp_files/leaflet.markercluster.js.t√©l√©chargement" async=""></script><script src="./Cartographie SMAC mdp_files/xlsx.full.min.js.t√©l√©chargement" async=""></script><script src="./Cartographie SMAC mdp_files/jspdf.umd.min.js.t√©l√©chargement" async=""></script><script src="./Cartographie SMAC mdp_files/jspdf.plugin.autotable.min.js.t√©l√©chargement" async=""></script></body></html>
